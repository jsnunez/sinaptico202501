<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SINAPTICO</title>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <link rel="stylesheet" href="styles/colores.css">
  <link rel="stylesheet" href="styles/postulaciones.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>

<body>

  <!-- Encabezado -->
  <header class="header">
    <div onclick="window.location.href='/helice'" class="logo">
      <!-- <span class="logo-icon">‚ö°</span> -->
      <span class="logo-text">SINAPTICO</span>
    </div>
    <nav class="nav">
      <button class="nav-button pulse" onclick="window.location.href='/helice'">H√©lice</button>
      <button class="nav-button pulse" onclick="window.location.href='/proyectos'">Proyectos</button>
      <button class="nav-button pulse" onclick="window.location.href='/innovacion'">Innovaci√≥n</button>

      <button class="nav-button pulse" onclick="window.location.href='/Conocimiento'">Conocimiento</button>
      <button class="nav-button pulse" onclick="window.location.href='/convocatorias'">Convocatorias</button>

      <button class="nav-button pulse" onclick="window.location.href='/eventos'">Eventos</button>

      <button class="nav-button pulse" onclick="window.location.href='/mapa-usuarios'">Mapa</button>
      <div style="position:fixed;top:10px;right:20px;z-index:1000;font-size:1.5em;cursor:pointer;">
        <span id="icono-notif">üîî <span
            style='background:red;color:white;border-radius:50%;padding:2px 7px;font-size:0.9em;'>0</span></span>
      </div>
      <div class="notificaciones" id="notificaciones"></div>

      <!-- <button class="nav-button pulse" id="cerrarSesion">Cerrar sesi√≥n</button> -->
      <!-- Bot√≥n con men√∫ desplegable -->
      <div class="dropdown">
        <button class=" " id="userMenuBtn">
          <div id="userPhoto ">
            <img class="imagenPerfil" id="imagenPerfilSecundaria" src="img/sinfoto.jpg" alt="Foto de perfil"
              onerror="this.onerror=null;this.src='img/sinfoto.jpg';">
          </div>

        </button>

        <div class="dropdown-menu" id="userMenu">
          <a href="/perfil">Perfil</a>
          <a href="/configuracion">Configuraci√≥n</a>
          <a href="#" id="cerrarSesion">Cerrar sesi√≥n</a>
        </div>
      </div>
    </nav>
  </header>

  <!-- Bienvenida y botones de acci√≥n -->
  <div style="display: none;" class="welcome-container">
    <div id="userPhoto">
      <img id="imagenPerfil" src="img/sinfoto.jpg" alt="Foto de perfil"
        onerror="this.onerror=null;this.src='img/sinfoto.jpg';">
    </div>

    <div class="welcome-text">
      <h2 id="bienvenido">Hola </h2>
      <!-- <p class="subtitle">Conectando entidades para potenciar la innovaci√≥n</p> -->
    </div>
    <div class="action-buttons">



    </div>


  </div>


  <!-- Modal Foto de Perfil -->
  <div id="modalFotoPerfil" class="modal">
    <div class="modal-content">
      <span class="close" id="cerrarModalFotoPerfil">&times;</span>
      <h2>Actualizar Foto de Perfil</h2>
      <form id="formFotoPerfil">
        <div class="form-group" style="text-align:center;">
          <img id="previewFotoPerfil" src="" alt="Foto actual"
            style="width:100px;height:100px;border-radius:50%;object-fit:cover;margin-bottom:15px;"
            onerror="this.onerror=null;this.src='img/sinfoto.jpg';">
        </div>
        <div class="form-group">
          <input type="file" id="inputFotoPerfil" name="fotoPerfil" accept="image/*" required>
        </div>
        <button type="submit" class="modal-button">Guardar Foto</button>
      </form>
    </div>
  </div>



  <!-- Contacto del lider de PPI -->
  <div id="modalPostulaciones" class="modal">
    <div class="modal-content" style="max-width:900px;">
      <span class="close" id="cerrarModalPostulaciones">&times;</span>
      <h2>Ficha T√©cnica de PPI</h2>
      <div class="form-section">
        <h3 class="section-title">Contacto L√≠der PPI</h3>
        <div class="input-box full-width">
          <label for="Entidad">Nombre de la Instituci√≥n responsable </label>
          <input disabled type="text" id="nombreEntidad" name="nombreEntidad"
            placeholder="Ingrese el nombre de la entidad responsable" "
                            required>
                    </div>

                <div class=" input-row">
          <div class="input-box">
            <label for="nombreLider">Nombre</label>
            <input type="text" id="nombreLider" name="nombreLider" placeholder="Ingrese el nombre del L√≠der PPI"
              required>
          </div>

        </div>

        <div class="input-row">
          <div class="input-box">
            <label for="correoLider">Correo Electr√≥nico</label>
            <input disabled="true" type="email" id="correoLider" name="correo" placeholder="Ingrese el correo" required>
          </div>

          <div class="input-box">
            <label for="telefonoLider">Tel√©fono / Celular</label>
            <input disabled="true" type="text" id="telefonoLider" name="telefonoLider"
              placeholder="Ingrese el tel√©fono o celular" required>
          </div>

        </div>

      </div>

      <!-- Contacto de la persona que diligencia la ficha
            <div class="form-section">
                <h3 class="section-title">Contacto de quien diligencia la ficha</h3>
                <div class="input-box full-width">
                    <label for="EntidadDiligencia">Nombre de la Instituci√≥n responsable </label>
                    <input type="text" id="nombreEntidad" name="nombreEntidad"
                        placeholder="Ingrese el nombre de la entidad responsable" required>
                </div>

                <div class=" input-row">
                    <div class="input-box">
                        <label for="nombreDiligenciador">Nombre</label>
                        <input type="text" id="nombreDiligenciador" name="nombreDiligenciador"
                            placeholder="Ingrese el nombre de quien diligencia la ficha" required>
                    </div>
                    <div class="input-box">
                        <label for="cargoDiligenciador">Cargo</label>
                        <input type="text" id="cargoDiligenciador" name="cargoDiligenciador"
                            placeholder="Ingrese el cargo quien diligencia la ficha" required>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-box">
                        <label for="correoDiligenciador">Correo Electr√≥nico</label>
                        <input type="email" id="correoDiligenciador" name="correo" placeholder="Ingrese el correo"
                            required>
                    </div>

                    <div class="input-box">
                        <label for="telefonoDiligenciador">Tel√©fono / Celular</label>
                        <input type="text" id="telefonoDiligenciador" name="telefonoDiligenciador"
                            placeholder="Ingrese el tel√©fono o celular" required>
                    </div>

                </div>



            </div> -->

      <!-- Informaci√≥n General del PPI -->
      <div class="form-section">
        <h3 class="section-title">Informaci√≥n General del PPI</h3>

        <div class="input-box full-width">
          <label for="nombrePPI">Nombre del PPI (Programa/Proyecto/Iniciativa)</label>
          <input type="text" id="nombrePPI" name="nombrePPI" placeholder="Ingrese el nombre del PPI" required>
        </div>
        <div class="input-box full-width">
          <label for="determinanteProductividad">Determinante de productividad al que se encuentra asociado el
            PPI</label>
          <input type="text" id="determinanteProductividad" name="determinanteProductividad"
            placeholder="Ingrese el nombre del determinante de productividad al que se encuentra asociado el PPI"
            required>
        </div>
        <div class="input-box full-width">
          <label for="componenteProductividad">Componente de productividad al que se encuentra asociado el
            PPI</label>
          <input type="text" id="componenteProductividad" name="componenteProductividad"
            placeholder="Ingrese el nombre del componente de productividad al que se encuentra asociado el PPI"
            required>
        </div>
        <div class="input-box full-width">
          <label for="objetivo">Objetivo del PPI <br>
            (Sea claro para que el equipo de expertos pueda identificar si soluciona fallas de mercado,
            gobierno o articulaci√≥n)</label>
          <input type="text" id="objetivo" name="objetivo" placeholder="Ingrese el Objetivo del PPI" required>
        </div>
        <div class="input-box">
          <label for="objetivo">¬øQu√© necesidad o problema resuelve esta Iniciativa?</label>
          <input type="text" id="objetivo" name="objetivo" placeholder="Sea lo m√°s claro posible" required>
        </div>
        <div class="input-box full-width">
          <label for="impactos"> Liste los tres principales impactos a obtener con el PPI planteado</label>
          <input type="text" id="impactos" name="impactos" placeholder="Ingrese los impactos" required>
        </div>
        <div class="input-box full-width">
          <label for="objetivosEspecificos">Liste los objetivos espec√≠ficos del proyecto </label>
          <input type="text" id="objetivosEspecificos" name="objetivosEspecificos"
            placeholder="Ingrese los objetivos espec√≠ficos (M√°ximo 5)" required>

        </div>

        <div class="input-box full-width">
          <label for="duracionPPI">¬øCu√°l es la duraci√≥n estimada del PPI?</label>
          <select id="duracionPPI" name="duracionPPI" required>
            <option value="">Seleccione una opci√≥n</option>
            <option value="Menos de un a√±o">Menos de un a√±o</option>
            <option value="Entre un a√±o y tres a√±os">Entre un a√±o y tres a√±os</option>
            <option value="M√°s de tres a√±os">M√°s de tres a√±os</option>
          </select>
        </div>
        <div class="input-box full-width">
          <label for="presupuestoPPI">¬øCu√°l es el presupuesto estimado del PPI?</label>
          <select id="presupuestoPPI" name="duracionPPI" required>
            <option value="">Seleccione una opci√≥n</option>
            <option value="De 0 a 100 millones de pesos">De 0 a 100 millones de pesos</option>
            <option value="De 101 a 500 millones de pesos">De 101 a 500 millones de pesos</option>
            <option value="De 501 a 1000 millones de pesos">De 501 a 1000 millones de pesos</option>
            <option value="De 1001 a 5000 millones de pesos">De 1001 a 5000 millones de pesos</option>
            <option value="M√°s de 5000 millones de pesos">M√°s de 5000 millones de pesos</option>
          </select>
        </div>


        <div class="input-box full-width">
          <label for="fasePPI">¬øEn qu√© fase se encuentra actualmente el PPI?</label>
          <select id="fasePPI" name="fasePPI" required>
            <option value="">Seleccione una opci√≥n</option>
            <option value="Fase 1: Idea">Fase 1: Idea</option>
            <option value="Fase 2: Formulaci√≥n o Prefactibilidad">Fase 2: Formulaci√≥n o Prefactibilidad
            </option>
            <option value="Fase 3: Factibilidad">Fase 3: Factibilidad</option>
            <option value="Contrataci√≥n">Contrataci√≥n</option>
            <option value="Ejecuci√≥n">Ejecuci√≥n</option>
          </select>
        </div>

      </div>
      <div style="text-align:right; margin-top:20px;">
        <button class="modal-button" id="guardarFichaPPI">Guardar Ficha T√©cnica</button>
      </div>
      <!-- An√°lisis de Equidad de G√©nero y Superaci√≥n de la Pobreza -->
      <!-- <div class="form-section">
                <h3 class="section-title">An√°lisis de Equidad de G√©nero y Superaci√≥n de la Pobreza </h3>

                <div class="input-box full-width">
                    <label for="Potencial">Potencial de generaci√≥n de empleo por estratos cuando el proyecto est√© en
                        desarrollo:</label>
                    <table class="PPI">
                        <thead>
                            <tr>
                                <th>Rango De Empleos</th>
                                <th>Estratos 1 y 2</th>
                                <th>Estratos 3 y 4</th>
                                <th>Estratos 5 y 6</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align:center;">1 a 10 </td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="1-10-1y2"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="1-10-3y4"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="1-10-5y6"></td>
                            </tr>
                            <tr>
                                <td style="text-align:center;">11 a 20 </td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="11-20-1y2"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="11-20-3y4"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="11-20-5y6"></td>
                            </tr>
                            <tr>
                                <td style="text-align:center;">21 a 30 </td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="21-30-1y2"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="21-30-3y4"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="21-30-5y6"></td>
                            </tr>
                            <tr>
                                <td style="text-align:center;">31 a o m√°s </td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="31+-1y2"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="31+-3y4"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="31+-5y6"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <br>
                <hr>
                <br>
                <div class="input-box full-width">
                    <label for="impactoEmpleo">Impactos esperados en generaci√≥n de empleo con la ejecuci√≥n del programa,
                        proyecto o iniciativa </label>
                    <input type="text" id="impactoEmpleo" name="impactoEmpleo"
                        placeholder="Ingrese los impactos esperados en la generaci√≥n de empleo con la ejecuci√≥n del PPI"
                        required>
                </div>
                <div class="input-box full-width">
                    <label for="impactoEquidad">Impactos esperados en reducci√≥n de brechas de equidad de g√©nero con la
                        ejecuci√≥n del programa, proyecto o iniciativa
                    </label>
                    <input type="text" id="impactoEquidad" name="impactoEquidad"
                        placeholder="Ingrese los Impactos esperados en reducci√≥n de brechas de equidad de g√©nero con la ejecuci√≥n del PPI"
                        required>
                </div>
                <div class="input-box full-width">
                    <label for="politicasPPI">Indique si el proyecto contempla pol√≠ticas de equidad de g√©nero para la
                        contrataci√≥n de sus empleados. Cu√°les?

                    </label>
                    <input type="text" id="politicasPPI" name="politicasPPI"
                        placeholder="Ingrese las politicas de equidad de g√©nero para la contrataci√≥n" required>
                </div>
            </div> -->
    </div>
  </div>

  <!-- Mis Proyectos -->

  <div class="main-content">
    <div style="display: flex;   justify-content: space-between;">
      <h2 class="title" id="misProyectos">Proyectos de </h2>
      </h2>
      <button class="action-button" id="postulaciones">
        <span class="button-icon"><i class="bi bi-lightbulb-fill " style="color: rgb(255, 248, 148);"></i></span>Nueva
        Idea de Proyecto
      </button>
    </div>

    <!-- Filtros -->
    <div class="filter-container">
      <input type="text" id="buscarMisProyectos" placeholder="Buscar tus proyectos..." class="filter-input">
    </div>

    <!-- Tabla de Mis Proyectos -->
    <table class="data-table" id="tablaPostulaciones">
      <thead>
        <tr>
          <th>Codigo</th>
          <th>Nombre del proyecto</th>
          <th>Objetivo</th>
          <th>Entidad</th>
          <th>L√≠der PPI</th>
          <th>Duraci√≥n</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="cuerpoTablaPostulaciones">
        <!-- Filas de datos se generar√°n din√°micamente aqu√≠ -->

      </tbody>
    </table>
    <div id="paginacionEntidades" class="pagination"></div>


  </div>

  <script>
    document.getElementById('guardarFichaPPI').onclick = async function () {
      // Recoge los datos del formulario
      const data = {
        entidadId: document.getElementById('nombreEntidad').value === 'null' ? null : document.getElementById('nombreEntidad').value,
        userId: obtenerCookie("userId"),
        userLiderId: document.getElementById('nombreLider').value,
        nombrePPI: document.getElementById('nombrePPI').value,
        determinanteProductividad: document.getElementById('determinanteProductividad').value,
        componenteProductividad: document.getElementById('componenteProductividad').value,
        objetivo: document.getElementById('objetivo').value,
        necesidadProblema: document.querySelectorAll('#objetivo')[1]?.value || '',
        impactos: document.getElementById('impactos').value,
        objetivosEspecificos: document.getElementById('objetivosEspecificos').value,
        duracionPPI: document.getElementById('duracionPPI').value,
        presupuestoPPI: document.getElementById('presupuestoPPI').value,
        fasePPI: document.getElementById('fasePPI').value,
        correoLider: document.getElementById('correoLider').value,
        telefonoLider: document.getElementById('telefonoLider').value,
        rangoDeEmpleos: 'sin usar',
        estratosBeneficiarios: 'sin usar',
        potencialEmpleo: 'sin usar',
        impactoEmpleo: 'sin usar',
        impactoEquidad: 'sin usar',
        politicasPPI: 'sin usar'
      };
      console.log(data);
      // Validaci√≥n r√°pida
      // Si entidadId es null, no lo validamos como error
      for (const key in data) {
        if (key !== 'entidadId' && !data[key]) {
          Swal.fire('Faltan datos', `Por favor completa el campo: ${key}.`, 'warning');
          return;
        }
      }

      try {
        const res = await fetch('/api/proyectos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (res.ok) {
          Swal.fire('Guardado', 'Ficha t√©cnica enviada correctamente.', 'success').then(() => {
            document.getElementById('modalPostulaciones').style.display = 'none';
            location.reload();
          });
        } else {
          Swal.fire('Error', result.message || 'No se pudo guardar.', 'error');
        }
      } catch (err) {
        Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error');
      }
    };
  </script>

  <script>
    // =========================
    // Utilidades
    // =========================
    function obtenerCookie(nombre) {
      const nombreCookie = `${nombre}=`;
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        let cookie = cookies[i].trim();
        if (cookie.indexOf(nombreCookie) === 0) {
          return cookie.substring(nombreCookie.length, cookie.length);
        }
      }
      return null;
    }

    const userId = obtenerCookie("userId");

    // =========================
    // Inicializaci√≥n de usuario (nombre, foto) y carga de proyectos
    // =========================
    (async () => {
      try {
        // Cargar usuario (para cabecera y foto)
        const resUser = await fetch(`/api/user/${userId}`);
        const dataUser = await resUser.json();

        const tituloProyectos = document.getElementById('misProyectos');
        if (tituloProyectos && dataUser?.name) {
          tituloProyectos.innerText = `Proyectos de ${dataUser.name}`;
        }
        document.getElementById("imagenPerfilSecundaria").src = dataUser.fotoPerfil ? "photo/" + dataUser.fotoPerfil : "photo/sinfoto.jpg";

        if (dataUser?.fotoPerfil) {
          const img = document.getElementById('imagenPerfil');
          if (img) img.src = dataUser.fotoPerfil;
        }

        // Determinar entidad y setear input nombreEntidad
        let entidadId = null;
        const resUE = await fetch(`/api/usuarioempresa/user/${userId}`);
        const dataUE = await resUE.json();

        if (Array.isArray(dataUE) && dataUE.length > 0 && dataUE[0].empresa) {
          entidadId = dataUE[0].empresa.id;
        } else {
          entidadId = 'null';
        }

        const inputEntidad = document.getElementById('nombreEntidad');
        if (inputEntidad) inputEntidad.value = entidadId;

        console.log('Entidad ID seleccionada:', entidadId);

        // Cargar proyectos por entidad o propios
        const resProy = await fetch(`/api/proyectos/entidadomis/${userId}/${entidadId}`);
        const dataProy = await resProy.json();
        console.log('Proyectos cargados:', dataProy);
        const tbody = document.getElementById('cuerpoTablaPostulaciones');
        if (tbody) {
          tbody.innerHTML = '';
          if (Array.isArray(dataProy) && dataProy.length > 0) {
            dataProy.forEach(proyecto => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
              <td>${proyecto.id || ''}</td>
              <td>${proyecto.nombrePPI || ''}</td>
              <td>${proyecto.objetivo || ''}</td>
              <td>${proyecto.entidad?.razonSocial ? proyecto.entidad.razonSocial : 'Independiente'}</td>
              <td>${proyecto.usuarioLider?.name || ''}</td>
              <td>${proyecto.duracionPPI || ''}</td>
              <td>${proyecto.fasePPI || ''}</td>
              <td>
                <button class="action-button" onclick="verMasProyecto(${proyecto.id})">
                  <span class="button-icon"><i class="bi bi-search" style="color:#333;"></i></span>Ver m√°s
                </button>
              </td>
            `;
              tbody.appendChild(tr);
            });
          }
        }
      } catch (err) {
        console.error('Error inicializando la vista:', err);
      }
    })();

    // =========================
    // Cerrar modal de postulaciones
    // =========================
    const btnCerrar = document.getElementById('cerrarModalPostulaciones');
    if (btnCerrar) {
      btnCerrar.onclick = function () {
        const modal = document.getElementById('modalPostulaciones');
        if (modal) modal.style.display = 'none';
      };
    }

    // =========================
    // Helpers para renderizar select de L√≠der
    // =========================
    async function renderLiderEmpresa(empresaId) {
      const nombreLiderInput = document.getElementById('nombreLider');
      const correoLiderInput = document.getElementById('correoLider');
      const telefonoLiderInput = document.getElementById('telefonoLider');

      const selectLider = document.createElement('select');
      selectLider.id = 'nombreLider';
      selectLider.name = 'nombreLider';
      selectLider.required = true;

      const res = await fetch(`/api/usuarioempresa/empresa/${empresaId}`);
      const data = await res.json();

      (data || []).forEach(item => {
        const option = document.createElement('option');
        option.value = item.User.id;
        option.text = `${item.User.name} (${item.Cargo?.nombre || 'Sin cargo'})`;

        option.dataset.email = item.User.email || '';
        option.dataset.telefono = item.User.telefono || '';
        selectLider.appendChild(option);
      });

      // Seleccionar el primero y actualizar campos
      if (selectLider.options.length > 0) {
        const selectedOption = selectLider.options[0];
        if (correoLiderInput) correoLiderInput.value = selectedOption.dataset.email || '';
        if (telefonoLiderInput) telefonoLiderInput.value = selectedOption.dataset.telefono || '';
      } else {
        if (correoLiderInput) correoLiderInput.value = '';
        if (telefonoLiderInput) telefonoLiderInput.value = '';
      }

      // Cambiar correo y tel√©fono al cambiar l√≠der
      selectLider.onchange = function () {
        const selectedOption = selectLider.options[selectLider.selectedIndex];
        if (correoLiderInput) correoLiderInput.value = selectedOption.dataset.email || '';
        if (telefonoLiderInput) telefonoLiderInput.value = selectedOption.dataset.telefono || '';
      };

      if (nombreLiderInput && nombreLiderInput.parentNode) {
        nombreLiderInput.parentNode.replaceChild(selectLider, nombreLiderInput);
      } else {
        // Si no existe el input a reemplazar, intenta anexar en un contenedor conocido
        const cont = document.getElementById('contenedorLider') || document.body;
        cont.appendChild(selectLider);
      }
    }

    async function renderLiderIndependiente() {
      const nombreLiderInput = document.getElementById('nombreLider');
      const correoLiderInput = document.getElementById('correoLider');
      const telefonoLiderInput = document.getElementById('telefonoLider');

      const selectLider = document.createElement('select');
      selectLider.id = 'nombreLider';
      selectLider.name = 'nombreLider';
      selectLider.required = true;

      const uid = obtenerCookie("userId");
      const resUser = await fetch(`/api/user/${uid}`);
      const user = await resUser.json();

      const optionUsuario = document.createElement('option');
      optionUsuario.value = uid;

      // Tomar nombre desde #bienvenido si existe ("Hola Nombre")

      optionUsuario.dataset.name = user.name || '';
      optionUsuario.dataset.email = user.email || '';
      optionUsuario.dataset.telefono = user.telefono || '';
      selectLider.appendChild(optionUsuario);
      optionUsuario.text = user.name || 'Usuario Actual';

      // Rellenar inputs con datos del usuario
      if (nombreLiderInput) nombreLiderInput.value = user.name || '';
      if (correoLiderInput) correoLiderInput.value = user.email || '';
      if (telefonoLiderInput) telefonoLiderInput.value = user.telefono || '';

      // Listener (aunque solo haya uno)
      selectLider.onchange = function () {

        const selectedOption = selectLider.options[selectLider.selectedIndex];
        if (correoLiderInput) correoLiderInput.value = selectedOption.dataset.email || '';
        if (telefonoLiderInput) telefonoLiderInput.value = selectedOption.dataset.telefono || '';
      };

      if (nombreLiderInput && nombreLiderInput.parentNode) {
        nombreLiderInput.parentNode.replaceChild(selectLider, nombreLiderInput);
      } else {
        const cont = document.getElementById('contenedorLider') || document.body;
        cont.appendChild(selectLider);
      }
    }

    // =========================
    // Listeners de cambio
    // =========================
    // Cambiar l√≠deres al cambiar el select de entidad (nombreEntidad)
    document.addEventListener('change', async function (e) {
      if (e.target && e.target.id === 'nombreEntidad') {
        const empresaId = e.target.value;
        if (empresaId && empresaId !== "null") {
          await renderLiderEmpresa(empresaId);
        } else {
          await renderLiderIndependiente();
        }
      }
    });

    // Cambiar correo y tel√©fono al cambiar l√≠der (nombreLider), incluso si no cambia la entidad
    document.addEventListener('change', function (e) {
      if (e.target && e.target.id === 'nombreLider') {
        const selectedOption = e.target.options[e.target.selectedIndex];
        const correoLiderInput = document.getElementById('correoLider');
        const telefonoLiderInput = document.getElementById('telefonoLider');
        if (correoLiderInput) correoLiderInput.value = selectedOption.dataset.email || '';
        if (telefonoLiderInput) telefonoLiderInput.value = selectedOption.dataset.telefono || '';
      }
    });

    // =========================
    // (Opcional) Si deseas forzar que al inicio se renderice el l√≠der acorde al valor cargado de nombreEntidad
    // =========================
    window.addEventListener('DOMContentLoaded', async () => {
      const inputEntidad = document.getElementById('nombreEntidad');
      if (inputEntidad) {
        if (inputEntidad.value && inputEntidad.value !== 'null') {
          await renderLiderEmpresa(inputEntidad.value);
        } else {
          await renderLiderIndependiente();
        }
      }
    });
  </script>
  <script>
    function verMasProyecto(proyectoId) {
      fetch(`/api/proyectos/${proyectoId}`)
        .then(res => res.json())
        .then(proyecto => {
          // Crea el modal si no existe
          console.log('Proyecto cargado para ver m√°s:', proyecto);
          let modal = document.getElementById('modalVerProyecto');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'modalVerProyecto';
            modal.className = 'modal';
            modal.innerHTML = `
                    <div class="modal-content" style="max-width:900px;">
                        <span class="close" id="cerrarModalVerProyecto">&times;</span>
                        <div style="display:flex;align-items:center;justify-content:center;">
                            <h2 style="margin-bottom:10px; text-align:center; color:#007bff;">Proyecto: </h2>
                            <h2 style="margin-bottom:10px; text-align:center;" id="tituloModalVerProyecto"></h2>
                        </div>

                        <div id="contenidoVerProyecto"></div>
                    </div>
                `;
            document.body.appendChild(modal);
            document.getElementById('cerrarModalVerProyecto').onclick = function () {
              modal.style.display = 'none';
            };
          }
          // Llena el contenido con tarjetas y estilos
          console.log('Proyecto cargado para ver m√°s:', proyecto);

          const contenido = document.getElementById('contenidoVerProyecto');
          contenido.innerHTML = `
                <div style="display:flex;flex-wrap:wrap;gap:24px;">
                    <div style="flex:1;min-width:280px;">
                        <div style="background:#f8f9fa;border-radius:12px;padding:18px;box-shadow:0 2px 8px #0001;">
                            <h3 style="margin-top:0;color:#333;">Informaci√≥n General</h3>
                            <p><strong>C√≥digo:</strong> ${proyecto.id || ''}</p>
                            <p><strong>Nombre:</strong> ${proyecto.nombrePPI || ''}</p>
                            <p><strong>Objetivo:</strong> ${proyecto.objetivo || ''}</p>
                            <p><strong>Necesidad/Problema:</strong> ${proyecto.necesidadProblema || ''}</p>
                            <p><strong>Impactos:</strong> ${proyecto.impactos || ''}</p>
                            <p><strong>Objetivos espec√≠ficos:</strong> ${proyecto.objetivosEspecificos || ''}</p>
                        </div>
                    </div>
                    <div style="flex:1;min-width:280px;">
                        <div style="background:#f8f9fa;border-radius:12px;padding:18px;box-shadow:0 2px 8px #0001;">
                            <h3 style="margin-top:0;color:#333;">Detalles T√©cnicos</h3>
                            <p><strong>Entidad:</strong> ${proyecto.entidad?.razonSocial || 'Independiente'}</p>
                            <p><strong>Duraci√≥n:</strong> ${proyecto.duracionPPI || ''}</p>
                            <p><strong>Presupuesto:</strong> ${proyecto.presupuestoPPI || ''}</p>
                            <p><strong>Fase:</strong> ${proyecto.fasePPI || ''}</p>
                            <p><strong>Determinante productividad:</strong> ${proyecto.determinanteProductividad || ''}</p>
                            <p><strong>Componente productividad:</strong> ${proyecto.componenteProductividad || ''}</p>
                        </div>
                    </div>
                    <div style="flex:1;min-width:280px;">
                        <div style="background:#f8f9fa;border-radius:12px;padding:18px;box-shadow:0 2px 8px #0001;">
                            <h3 style="margin-top:0;color:#333;">Contacto L√≠der</h3>
                            <p><strong>Nombre:</strong> ${proyecto.usuarioLider?.name || ''}</p>
                            <p><strong>Correo:</strong> <a href="mailto:${proyecto.usuarioLider?.email || ''}" style="color:#007bff;">${proyecto.usuarioLider?.email || ''}</a></p>
                            <p><strong>Tel√©fono:</strong> <a href="tel:${proyecto.usuarioLider?.telefono || ''}" style="color:#007bff;">${proyecto.usuarioLider?.telefono || ''}</a></p>
                        </div>
                    </div>
                </div>
            `;
          document.getElementById('tituloModalVerProyecto').innerText = `${proyecto.nombrePPI || 'Detalle del Proyecto'}`;
          modal.style.display = 'block';
        })
        .catch(() => {
          Swal.fire('Error', 'No se pudo cargar el proyecto.', 'error');
        });
    }
  </script>
  <script>
    document.getElementById("cerrarSesion").addEventListener("click", () => {
      Swal.fire({
        title: '¬øEst√°s seguro?',
        text: '¬øQuer√©s cerrar sesi√≥n?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, cerrar sesi√≥n',
        cancelButtonText: 'Cancelar',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          // Borrar cookies y redirigir
          document.cookie = 'jwt=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          document.cookie = 'user=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          document.cookie = 'userId=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          document.location.href = "/";

        }
        // Si el usuario cancela, no pasa nada
      });
    });
  </script>
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);

      // üëâ Cache del usuario actual para usarlo en "Independiente"
      let userSelf = { id: null, name: '', email: '', telefono: '' };

      function setContacto(email = '', telefono = '') {

        $('correoLider').value = email || '';
        $('telefonoLider').value = telefono || '';
      }

      function renderSelectLider(options = [], preselectValue = null) {
        const old = $('nombreLider');
        const select = document.createElement('select');
        select.id = 'nombreLider';
        select.name = 'nombreLider';
        select.required = true;

        options.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.value;
          opt.text = o.label;
          opt.dataset.email = o.email || '';
          opt.dataset.telefono = o.telefono || '';
          if (preselectValue && preselectValue == o.value) opt.selected = true;
          select.appendChild(opt);
        });

        select.addEventListener('change', () => {
          const sel = select.options[select.selectedIndex];
          setContacto(sel?.dataset.email, sel?.dataset.telefono);
        });

        old?.parentNode.replaceChild(select, old);

        if (select.options.length > 0) {
          const sel = select.options[select.selectedIndex];
          setContacto(sel?.dataset.email, sel?.dataset.telefono);
        } else {
          setContacto('', '');
        }
      }

      function renderSelectEntidad({ empresa } = {}) {
        const old = $('nombreEntidad');
        const select = document.createElement('select');
        select.id = 'nombreEntidad';
        select.name = 'nombreEntidad';
        select.required = true;

        const optInd = document.createElement('option');
        optInd.value = 'null';
        optInd.text = 'Independiente';
        select.appendChild(optInd);

        let preselect = 'null';
        if (empresa && empresa.id) {
          const optEmp = document.createElement('option');
          optEmp.value = String(empresa.id);
          optEmp.text = empresa.razonSocial || `Empresa ${empresa.id}`;
          select.appendChild(optEmp);
          preselect = String(empresa.id);
        }

        select.value = preselect;

        // üí° Al cambiar entidad: si es Independiente, seteamos contacto del usuario
        select.addEventListener('change', async () => {
          await onEntidadChange(select.value);
        });

        old?.parentNode.replaceChild(select, old);
        return preselect;
      }

      async function loadLideresPorEmpresa(empresaId) {
        const res = await fetch(`/api/usuarioempresa/empresa/${empresaId}`);
        const data = await res.json();
        const opciones = (Array.isArray(data) ? data : []).map(item => ({
          value: String(item.User.id),
          label: `${item.User.name} (${item.Cargo?.nombre || '‚Äî'})`,
          email: item.User.email || '',
          telefono: item.User.telefono || ''
        }));
        renderSelectLider(opciones);
      }

      // ‚úÖ Ahora recibe userSelf y actualiza contacto
      function setIndependienteAsLider() {
        renderSelectLider([{
          value: String(userSelf.id || obtenerCookie("userId")),
          label: userSelf.name || 'Usuario Actual',
          email: userSelf.email || '',
          telefono: userSelf.telefono || ''
        }], String(userSelf.id || obtenerCookie("userId")));
        console
        // Fuerza contacto del usuario (por si ven√≠amos con datos de empresa)
        // Trae email y tel√©fono del usuario actual por fetch
        fetch(`/api/user/${userSelf.id}`)
          .then(res => res.json())
          .then(user => {
            setContacto(user.email || '', user.telefono || '', user.name || '');
          })
          .catch(() => {
            setContacto(userSelf.email || '', userSelf.telefono || '', userSelf.name || '');
          });
      }

      async function onEntidadChange(empresaValue) {
        if (empresaValue && empresaValue !== 'null') {
          await loadLideresPorEmpresa(empresaValue);
        } else {
          setIndependienteAsLider();
        }
      }

      // üß† Abrir modal: cargamos user+empresa, llenamos entidad, y luego l√≠deres/independiente
      $('postulaciones').addEventListener('click', async () => {
        $('modalPostulaciones').style.display = 'block';
        try {
          const res = await fetch(`/api/usuarioempresa/user/${userId}`);
          const data = await res.json();

          // Intenta sacar el usuario del payload recibido (aj√∫stalo si tu API difiere)
          const userFromApi = Array.isArray(data) ? (data[0]?.User || data[0]?.user) : null;

          userSelf = {
            id: userFromApi?.id || obtenerCookie("userId"),
            name: $('bienvenido')?.innerText?.replace('Hola ', '') || userFromApi?.name || '',
            email: userFromApi?.email || ($('correoUsuario')?.value || ''),     // opcional: hidden input #correoUsuario
            telefono: userFromApi?.telefono || ($('telefonoUsuario')?.value || '') // opcional: hidden input #telefonoUsuario
          };

          const empresa = (Array.isArray(data) && data[0]?.empresa) ? data[0].empresa : null;

          const seleccionado = renderSelectEntidad({ empresa });
          await onEntidadChange(seleccionado);
        } catch (err) {
          console.error('Error cargando usuario/empresa:', err);
          // Fallback: usuario independiente
          const nombre = $('bienvenido')?.innerText?.replace('Hola ', '') || 'Yo';
          userSelf = {
            id: obtenerCookie("userId"),
            name: nombre,
            email: $('correoUsuario')?.value || '',     // si agregas estos inputs hidden
            telefono: $('telefonoUsuario')?.value || ''
          };
          renderSelectEntidad({ empresa: null });
          setIndependienteAsLider();
        }
      });

      $('cerrarModalPostulaciones').addEventListener('click', () => {
        $('modalPostulaciones').style.display = 'none';
      });
    })();
  </script>


  <script>
    // Abrir modal al hacer clic en la foto de usuario
    document.getElementById('userPhoto').onclick = function () {
      document.getElementById('modalFotoPerfil').style.display = 'block';

      // Opcional: cargar foto actual si tienes la URL
      // document.getElementById('previewFotoPerfil').src = 'URL_DE_LA_FOTO_ACTUAL';
    };
    // Cerrar modal
    document.getElementById('cerrarModalFotoPerfil').onclick = function () {
      document.getElementById('modalFotoPerfil').style.display = 'none';
    };
    // Vista previa de la imagen seleccionada
    document.getElementById('inputFotoPerfil').onchange = function (e) {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('previewFotoPerfil').src = URL.createObjectURL(file);
      }
    };
    // Guardar foto (debes implementar la l√≥gica de subida en tu backend)
    document.getElementById('formFotoPerfil').onsubmit = function (e) {
      e.preventDefault();
      const userId = obtenerCookie("userId");

      // Ejemplo de subida con fetch y FormData
      const formData = new FormData();
      console.log(document.getElementById('inputFotoPerfil').files[0]);
      formData.append('fotoPerfil', document.getElementById('inputFotoPerfil').files[0]);
      alert('subiendo');
      fetch(`/api/user/cambiarFoto/${userId}`, {
        method: 'PUT',
        body: formData
      }).then(res => res.json())
        .then(data => {
          // Actualiza la foto en la interfaz si es necesario
          document.getElementById('modalFotoPerfil').style.display = 'none';
          // document.getElementById('userPhoto').innerHTML = '<img src="URL_NUEVA_FOTO" ...>';
          location.reload(); // O actualiza solo la foto
        }).catch(() => {
          alert('Error al subir la foto');
        });
    };

  </script>

  <!-- Scripts -->

  <script src="js/notificaciones.js"></script>
  <script src="/js/websocket.js"></script>
  <!-- <script src="/js/cargarProyectos.js"></script> -->



  <script>
    const userMenuBtn = document.getElementById("userMenuBtn");
    const dropdown = userMenuBtn.closest(".dropdown");

    // Mostrar / ocultar el men√∫ al hacer clic
    userMenuBtn.addEventListener("click", (event) => {
      event.stopPropagation(); // evita que el clic cierre inmediatamente el men√∫
      dropdown.classList.toggle("show");
    });

    // Cerrar el men√∫ si haces clic fuera
    document.addEventListener("click", () => {
      dropdown.classList.remove("show");
    });
  </script>



</body>

</html>