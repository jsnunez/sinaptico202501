<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Aplicaciones - Convocatorias CRCI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card i {
            font-size: 2.5em;
            margin-bottom: 15px;
            color: #667eea;
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filters {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .filters h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-info {
            background: #4299e1;
            color: white;
        }

        .applications-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-postulado { background: #e2e8f0; color: #2d3748; }
        .badge-evaluacion { background: #fef5e7; color: #744210; }
        .badge-preseleccionado { background: #e6fffa; color: #234e52; }
        .badge-aprobado { background: #f0fff4; color: #22543d; }
        .badge-rechazado { background: #fed7d7; color: #742a2a; }
        .badge-retirado { background: #edf2f7; color: #4a5568; }

        .score {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-bar {
            width: 60px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #f56565, #ed8936, #48bb78);
            transition: width 0.3s ease;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .actions .btn {
            padding: 8px 12px;
            font-size: 12px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            font-size: 1.2em;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            color: #cbd5e0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #333;
        }

        .evaluation-form {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }

            .applications-table {
                overflow-x: auto;
            }

            table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-clipboard-list"></i> Gestión de Aplicaciones a Convocatorias</h1>
            <p>Panel de administración para evaluar y gestionar proyectos aplicados a convocatorias</p>
        </div>

        <!-- Estadísticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-paper-plane"></i>
                <div class="stat-number" id="statTotal">-</div>
                <div class="stat-label">Total Aplicaciones</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-search"></i>
                <div class="stat-number" id="statEvaluacion">-</div>
                <div class="stat-label">En Evaluación</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle"></i>
                <div class="stat-number" id="statAprobadas">-</div>
                <div class="stat-label">Aprobadas</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-star"></i>
                <div class="stat-number" id="statPreseleccionadas">-</div>
                <div class="stat-label">Preseleccionadas</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filters">
            <h3><i class="fas fa-filter"></i> Filtros de Búsqueda</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filtroConvocatoria">Convocatoria</label>
                    <select id="filtroConvocatoria">
                        <option value="">Todas las convocatorias</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filtroEstado">Estado</label>
                    <select id="filtroEstado">
                        <option value="">Todos los estados</option>
                        <option value="Postulado">Postulado</option>
                        <option value="En Evaluacion">En Evaluación</option>
                        <option value="Preseleccionado">Preseleccionado</option>
                        <option value="Aprobado">Aprobado</option>
                        <option value="Rechazado">Rechazado</option>
                        <option value="Retirado">Retirado</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filtroEvaluador">Evaluador</label>
                    <select id="filtroEvaluador">
                        <option value="">Todos los evaluadores</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="aplicarFiltros()">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabla de aplicaciones -->
        <div class="applications-table">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3><i class="fas fa-list"></i> Aplicaciones de Proyectos</h3>
                <button class="btn btn-success" onclick="exportarDatos()">
                    <i class="fas fa-download"></i> Exportar Excel
                </button>
            </div>

            <div id="tablaContainer">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Cargando aplicaciones...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Evaluación -->
    <div id="modalEvaluacion" class="modal">
        <div class="modal-content">
            <span class="close" id="cerrarModal">&times;</span>
            <h2><i class="fas fa-edit"></i> Evaluar Aplicación</h2>
            
            <div id="infoAplicacion"></div>

            <form class="evaluation-form" id="formEvaluacion">
                <div class="form-group">
                    <label for="nuevoEstado">Estado de Evaluación</label>
                    <select id="nuevoEstado" required>
                        <option value="Postulado">Postulado</option>
                        <option value="En Evaluacion">En Evaluación</option>
                        <option value="Preseleccionado">Preseleccionado</option>
                        <option value="Aprobado">Aprobado</option>
                        <option value="Rechazado">Rechazado</option>
                        <option value="Retirado">Retirado</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="puntuacionTecnica">Puntuación Técnica (0-100)</label>
                        <input type="number" id="puntuacionTecnica" min="0" max="100" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="puntuacionFinanciera">Puntuación Financiera (0-100)</label>
                        <input type="number" id="puntuacionFinanciera" min="0" max="100" step="0.1">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="puntuacionImpacto">Puntuación de Impacto (0-100)</label>
                        <input type="number" id="puntuacionImpacto" min="0" max="100" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="evaluadorAsignado">Evaluador Asignado</label>
                        <input type="email" id="evaluadorAsignado" placeholder="evaluador@ejemplo.com">
                    </div>
                </div>

                <div class="form-group">
                    <label for="observacionesEvaluacion">Observaciones de Evaluación</label>
                    <textarea id="observacionesEvaluacion" placeholder="Ingrese observaciones detalladas sobre la evaluación..."></textarea>
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Evaluación
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let aplicacionesOriginales = [];
        let aplicacionesFiltradas = [];
        let aplicacionActual = null;

        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
            configurarEventos();
        });

        function configurarEventos() {
            // Modal events
            document.getElementById('cerrarModal').addEventListener('click', cerrarModal);
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('modalEvaluacion');
                if (event.target === modal) {
                    cerrarModal();
                }
            });

            // Form submission
            document.getElementById('formEvaluacion').addEventListener('submit', guardarEvaluacion);
        }

        async function cargarDatos() {
            try {
                // Cargar aplicaciones
                const response = await fetch('/api/convocatoria-proyectos');
                const data = await response.json();
                
                if (data.success) {
                    aplicacionesOriginales = data.data;
                    aplicacionesFiltradas = [...aplicacionesOriginales];
                    
                    actualizarEstadisticas();
                    cargarFiltros();
                    renderizarTabla();
                } else {
                    throw new Error(data.message || 'Error al cargar datos');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudieron cargar las aplicaciones'
                });
            }
        }

        function actualizarEstadisticas() {
            const stats = {
                total: aplicacionesOriginales.length,
                evaluacion: aplicacionesOriginales.filter(a => a.estado === 'En Evaluacion').length,
                aprobadas: aplicacionesOriginales.filter(a => a.estado === 'Aprobado').length,
                preseleccionadas: aplicacionesOriginales.filter(a => a.estado === 'Preseleccionado').length
            };

            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statEvaluacion').textContent = stats.evaluacion;
            document.getElementById('statAprobadas').textContent = stats.aprobadas;
            document.getElementById('statPreseleccionadas').textContent = stats.preseleccionadas;
        }

        function cargarFiltros() {
            // Cargar convocatorias únicas
            const convocatorias = [...new Set(aplicacionesOriginales
                .filter(a => a.convocatoria)
                .map(a => a.convocatoria))];
            
            const selectConvocatoria = document.getElementById('filtroConvocatoria');
            selectConvocatoria.innerHTML = '<option value="">Todas las convocatorias</option>';
            convocatorias.forEach(conv => {
                const option = document.createElement('option');
                option.value = conv.id;
                option.textContent = conv.titulo;
                selectConvocatoria.appendChild(option);
            });

            // Cargar evaluadores únicos
            const evaluadores = [...new Set(aplicacionesOriginales
                .filter(a => a.evaluadorAsignado)
                .map(a => a.evaluadorAsignado))];
            
            const selectEvaluador = document.getElementById('filtroEvaluador');
            selectEvaluador.innerHTML = '<option value="">Todos los evaluadores</option>';
            evaluadores.forEach(eval => {
                const option = document.createElement('option');
                option.value = eval;
                option.textContent = eval;
                selectEvaluador.appendChild(option);
            });
        }

        function aplicarFiltros() {
            const convocatoriaFiltro = document.getElementById('filtroConvocatoria').value;
            const estadoFiltro = document.getElementById('filtroEstado').value;
            const evaluadorFiltro = document.getElementById('filtroEvaluador').value;

            aplicacionesFiltradas = aplicacionesOriginales.filter(aplicacion => {
                let cumpleFiltros = true;

                if (convocatoriaFiltro && (!aplicacion.convocatoria || aplicacion.convocatoria.id !== parseInt(convocatoriaFiltro))) {
                    cumpleFiltros = false;
                }

                if (estadoFiltro && aplicacion.estado !== estadoFiltro) {
                    cumpleFiltros = false;
                }

                if (evaluadorFiltro && aplicacion.evaluadorAsignado !== evaluadorFiltro) {
                    cumpleFiltros = false;
                }

                return cumpleFiltros;
            });

            renderizarTabla();
        }

        function renderizarTabla() {
            const container = document.getElementById('tablaContainer');
            
            if (aplicacionesFiltradas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No se encontraron aplicaciones</h3>
                        <p>No hay aplicaciones que coincidan con los filtros seleccionados</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Proyecto</th>
                            <th>Convocatoria</th>
                            <th>Estado</th>
                            <th>Fecha Aplicación</th>
                            <th>Puntuación</th>
                            <th>Evaluador</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            aplicacionesFiltradas.forEach(aplicacion => {
                const proyecto = aplicacion.proyecto?.nombrePPI || `Proyecto ${aplicacion.proyectoId}`;
                const convocatoria = aplicacion.convocatoria?.titulo || `Convocatoria ${aplicacion.convocatoriaId}`;
                const puntuacion = parseFloat(aplicacion.puntuacionTotal) || 0;
                const evaluador = aplicacion.evaluadorAsignado || 'Sin asignar';
                const fechaAplicacion = new Date(aplicacion.fechaAplicacion).toLocaleDateString();

                html += `
                    <tr>
                        <td>
                            <strong>${proyecto}</strong>
                            <br>
                            <small style="color: #666;">ID: ${aplicacion.proyectoId}</small>
                        </td>
                        <td>${convocatoria}</td>
                        <td>
                            <span class="badge badge-${aplicacion.estado.toLowerCase().replace(' ', '')}">
                                ${aplicacion.estado}
                            </span>
                        </td>
                        <td>${fechaAplicacion}</td>
                        <td>
                            <div class="score">
                                <span>${puntuacion.toFixed(1)}</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${puntuacion}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <small>${evaluador}</small>
                        </td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-info" onclick="verDetalles(${aplicacion.id})" title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-primary" onclick="evaluarAplicacion(${aplicacion.id})" title="Evaluar">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function verDetalles(aplicacionId) {
            const aplicacion = aplicacionesOriginales.find(a => a.id === aplicacionId);
            if (!aplicacion) return;

            const proyecto = aplicacion.proyecto?.nombrePPI || `Proyecto ${aplicacion.proyectoId}`;
            const convocatoria = aplicacion.convocatoria?.titulo || `Convocatoria ${aplicacion.convocatoriaId}`;

            let documentos = 'No disponible';
            try {
                const docs = JSON.parse(aplicacion.documentosPresentados || '{}');
                documentos = Object.entries(docs)
                    .filter(([key, value]) => value)
                    .map(([key]) => key.replace(/([A-Z])/g, ' $1').toLowerCase())
                    .join(', ');
            } catch (e) {
                documentos = aplicacion.documentosPresentados || 'No disponible';
            }

            Swal.fire({
                title: 'Detalles de la Aplicación',
                html: `
                    <div style="text-align: left; max-height: 400px; overflow-y: auto;">
                        <p><strong>Proyecto:</strong> ${proyecto}</p>
                        <p><strong>Convocatoria:</strong> ${convocatoria}</p>
                        <p><strong>Estado:</strong> <span class="badge badge-${aplicacion.estado.toLowerCase().replace(' ', '')}">${aplicacion.estado}</span></p>
                        <p><strong>Fecha de Aplicación:</strong> ${new Date(aplicacion.fechaAplicacion).toLocaleDateString()}</p>
                        
                        ${aplicacion.puntuacionTotal ? `
                            <hr style="margin: 15px 0;">
                            <h4>Puntuaciones</h4>
                            <p><strong>Técnica:</strong> ${aplicacion.puntuacionTecnica || 'N/A'}</p>
                            <p><strong>Financiera:</strong> ${aplicacion.puntuacionFinanciera || 'N/A'}</p>
                            <p><strong>Impacto:</strong> ${aplicacion.puntuacionImpacto || 'N/A'}</p>
                            <p><strong>Total:</strong> ${aplicacion.puntuacionTotal}/100</p>
                        ` : ''}
                        
                        ${aplicacion.evaluadorAsignado ? `
                            <p><strong>Evaluador:</strong> ${aplicacion.evaluadorAsignado}</p>
                        ` : ''}
                        
                        <hr style="margin: 15px 0;">
                        <h4>Documentos Presentados</h4>
                        <p>${documentos}</p>
                        
                        ${aplicacion.observacionesAplicacion ? `
                            <h4>Observaciones de Aplicación</h4>
                            <p>${aplicacion.observacionesAplicacion}</p>
                        ` : ''}
                        
                        ${aplicacion.observacionesEvaluacion ? `
                            <h4>Observaciones de Evaluación</h4>
                            <p>${aplicacion.observacionesEvaluacion}</p>
                        ` : ''}
                    </div>
                `,
                width: '600px',
                confirmButtonText: 'Cerrar'
            });
        }

        function evaluarAplicacion(aplicacionId) {
            aplicacionActual = aplicacionesOriginales.find(a => a.id === aplicacionId);
            if (!aplicacionActual) return;

            const proyecto = aplicacionActual.proyecto?.nombrePPI || `Proyecto ${aplicacionActual.proyectoId}`;
            const convocatoria = aplicacionActual.convocatoria?.titulo || `Convocatoria ${aplicacionActual.convocatoriaId}`;

            // Llenar información de la aplicación
            document.getElementById('infoAplicacion').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4>${proyecto}</h4>
                    <p><strong>Convocatoria:</strong> ${convocatoria}</p>
                    <p><strong>Estado actual:</strong> <span class="badge badge-${aplicacionActual.estado.toLowerCase().replace(' ', '')}">${aplicacionActual.estado}</span></p>
                </div>
            `;

            // Llenar formulario con datos existentes
            document.getElementById('nuevoEstado').value = aplicacionActual.estado;
            document.getElementById('puntuacionTecnica').value = aplicacionActual.puntuacionTecnica || '';
            document.getElementById('puntuacionFinanciera').value = aplicacionActual.puntuacionFinanciera || '';
            document.getElementById('puntuacionImpacto').value = aplicacionActual.puntuacionImpacto || '';
            document.getElementById('evaluadorAsignado').value = aplicacionActual.evaluadorAsignado || '';
            document.getElementById('observacionesEvaluacion').value = aplicacionActual.observacionesEvaluacion || '';

            // Mostrar modal
            document.getElementById('modalEvaluacion').style.display = 'block';
        }

        function cerrarModal() {
            document.getElementById('modalEvaluacion').style.display = 'none';
            aplicacionActual = null;
        }

        async function guardarEvaluacion(event) {
            event.preventDefault();

            if (!aplicacionActual) return;

            try {
                const formData = {
                    estado: document.getElementById('nuevoEstado').value,
                    puntuacionTecnica: document.getElementById('puntuacionTecnica').value ? parseFloat(document.getElementById('puntuacionTecnica').value) : null,
                    puntuacionFinanciera: document.getElementById('puntuacionFinanciera').value ? parseFloat(document.getElementById('puntuacionFinanciera').value) : null,
                    puntuacionImpacto: document.getElementById('puntuacionImpacto').value ? parseFloat(document.getElementById('puntuacionImpacto').value) : null,
                    evaluadorAsignado: document.getElementById('evaluadorAsignado').value || null,
                    observacionesEvaluacion: document.getElementById('observacionesEvaluacion').value || null,
                    fechaEvaluacion: new Date().toISOString()
                };

                const response = await fetch(`/api/convocatoria-proyectos/${aplicacionActual.id}/evaluacion`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Evaluación guardada',
                        text: 'La evaluación se ha actualizado correctamente'
                    });
                    cerrarModal();
                    cargarDatos(); // Recargar datos
                } else {
                    throw new Error(result.message || 'Error al guardar evaluación');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudo guardar la evaluación'
                });
            }
        }

        function exportarDatos() {
            // Crear datos para exportar
            const datosExport = aplicacionesFiltradas.map(app => ({
                'Proyecto': app.proyecto?.nombrePPI || `Proyecto ${app.proyectoId}`,
                'Convocatoria': app.convocatoria?.titulo || `Convocatoria ${app.convocatoriaId}`,
                'Estado': app.estado,
                'Fecha Aplicación': new Date(app.fechaAplicacion).toLocaleDateString(),
                'Puntuación Técnica': app.puntuacionTecnica || '',
                'Puntuación Financiera': app.puntuacionFinanciera || '',
                'Puntuación Impacto': app.puntuacionImpacto || '',
                'Puntuación Total': app.puntuacionTotal || '',
                'Evaluador': app.evaluadorAsignado || '',
                'Observaciones Aplicación': app.observacionesAplicacion || '',
                'Observaciones Evaluación': app.observacionesEvaluacion || ''
            }));

            // Crear CSV
            const headers = Object.keys(datosExport[0] || {});
            const csvContent = [
                headers.join(','),
                ...datosExport.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
            ].join('\n');

            // Descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `aplicaciones-convocatorias-${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            Swal.fire({
                icon: 'success',
                title: 'Exportación completada',
                text: 'Los datos se han exportado correctamente'
            });
        }
    </script>
</body>
</html>