<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SINAPTICO</title>

  <!-- Librer铆as -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link rel="stylesheet" href="/styles/colores.css">
  <link rel="stylesheet" href="/styles/stylehelice2.css">
  <link rel="stylesheet" href="/styles/eventos.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- PRIMERO cargar config.js para que API_BASE_URL exista -->
  <script src="/js/config.js"></script>

</head>

<body>

  <!-- Fondo neuronas -->
  <div class="neural-background">
    <canvas id="neuralCanvas"></canvas>
  </div>

  <!-- Encabezado -->
  <header>
    <div class="header">

      <div onclick="window.location.href='/helice'">
        <img src="/img/logo1.png" alt="SINAPTICO" class="logo" style="height:8vh;">
      </div>

      <div style="display:flex;align-items:center;gap:20px;">

        <div style="font-size:1.5em;cursor:pointer;">
          <span id="icono-notif"> <span
              style="background:red;color:white;border-radius:50%;padding:2px 7px;font-size:0.9em;">0</span></span>
        </div>

        <div class="notificaciones" id="notificaciones"></div>

        <div class="dropdown">
          <button id="userMenuBtn" style="display:flex;align-items:center;">
            <img class="imagenPerfil" id="imagenPerfilSecundaria" src="/img/sinfoto.jpg"
              onerror="this.src='/img/sinfoto.jpg'">
            <h3 id="nombreUsuarioHeader" style="color:white;margin-left:10px;">
              Usuario <i class="bi bi-chevron-down"></i>
            </h3>
          </button>

          <div class="dropdown-menu" id="userMenu">
            <a class="perfilUser" id="perfilUser">Perfil</a>
            <a id="habilitarMiEmpresa" style="display:none;">Empresa</a>
            <a href="#" id="cerrarSesion">Cerrar sesi贸n</a>
          </div>
        </div>

      </div>

    </div>

    <nav class="nav">

      <button class="nav-button" onclick="window.location.href='/helice'">Inicio</button>

      <div class="dropdown menuG">
        <button class="nav-button dropdown-btnG">Directorio</button>
        <div class="dropdown-menu dropdown-menuG">
          <a href="/directorio">Entidades</a>
          <a href="/directorioPersonas">Personas</a>
        </div>
      </div>

      <button class="nav-button" onclick="window.location.href='/proyectos'">Proyectos</button>
      <button class="nav-button" onclick="window.location.href='/ofertaRegional'">Oferta Regional</button>

      <div class="dropdown menuG">
        <button class="nav-button dropdown-btnG">Innovaci贸n Abierta</button>
        <div class="dropdown-menu dropdown-menuG">
          <a href="/retosEmpresariales">Retos Empresariales</a>
          <a href="/retosAula">Retos de Aula</a>
        </div>
      </div>

      <div class="dropdown menuG">
        <button class="nav-button dropdown-btnG">Conocimiento Abierto</button>
        <div class="dropdown-menu dropdown-menuG">
          <a href="/conocimientoCursosVirtuales">Cursos</a>
          <a href="/conocimientoBiblioteca">Biblioteca</a>
        </div>
      </div>

      <button class="nav-button" onclick="window.location.href='/convocatorias'">Convocatorias</button>
      <button class="nav-button" onclick="window.location.href='/eventos'">Eventos</button>

    </nav>

  </header>

  <!-- Bienvenida -->
  <div class="welcome-container">
    <div class="welcome-text">
      <h2 id="title">Eventos</h2>
      <p class="subtitle">Consulta los eventos activos del ecosistema CTEI de Santander</p>
    </div>

    <div class="action-buttons" style="display:flex;">
      <button class="action-button" id="btnNuevoEvento">
        <i class="fas fa-plus button-icon"></i> Nuevo evento
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filter-container">
    <input type="text" id="buscarEvento" placeholder="Nombre Evento" class="filter-input">
    <select id="estadoFiltro" class="filter-select">
      <option value="">Todos los Estados</option>
      <option value="Abierto">Abierto</option>
      <option value="Cerrado">Cerrado</option>
    </select>
  </div>

  <!-- Lista de eventos -->
  <div class="main-content" id="eventos"></div>

  <!-- Modal Crear / Editar Evento -->
  <div id="modalEdicion" class="modal">
    <div class="modal-content">

      <div class="modal-header">
        <h3 id="opcionEvento">Nuevo Evento</h3>
        <span id="closeModalEdicion" class="close">&times;</span>
      </div>

      <form id="formEditarEvento">

        <!-- Imagen -->
        <div class="form-group">
          <label>Subir Imagen:</label>
          <input type="file" id="fileImagenEvento" accept="image/*">
          <img id="previewImagenEvento" style="max-width:120px;max-height:120px;border-radius:10px;margin-top:10px;">
        </div>

        <!-- Script Preview Imagen -->
        <script>
          let selectedFile = null;

          document.getElementById("fileImagenEvento").addEventListener("change", (e) => {
        selectedFile = e.target.files[0];
        if (!selectedFile) return;

        const reader = new FileReader();
        reader.onload = ev => {
          document.getElementById("previewImagenEvento").src = ev.target.result;
        };
        reader.readAsDataURL(selectedFile);
          });
        </script>

        <!-- Campos -->
        <div class="form-group">
          <label>T铆tulo:</label>
          <input type="text" id="tituloEvento" required>
        </div>

        <div class="form-group">
          <label>C贸digo:</label>
          <input type="text" id="codigoEvento" required maxlength="20">
        </div>

        <div class="form-group">
          <label>Descripci贸n:</label>
          <textarea id="descripcionEvento" required minlength="10"></textarea>
        </div>

        <div class="form-group">
          <label>Modalidad:</label>
          <select id="modalidadEvento" required>
        <option value="presencial">Presencial</option>
        <option value="virtual">Virtual</option>
        <option value="hibrido">H铆brido</option>
          </select>
        </div>

        <div class="form-group">
          <label>Ubicaci贸n:</label>
          <input type="text" id="ubicacionEvento">
        </div>

        <div class="form-group">
          <label>Fecha:</label>
          <input type="date" id="fechaEvento" required>
        </div>

        <div class="form-group">
          <label>Hora Inicio:</label>
          <input type="time" id="horaInicioEvento" required>
        </div>

        <div class="form-group">
          <label>Hora Fin:</label>
          <input type="time" id="horaFinEvento" required>
        </div>

        <div class="form-group">
          <label>Cupo M谩ximo:</label>
          <input type="number" id="cupoMaximoEvento" min="1">
        </div>

        <div class="form-group">
          <label>Inscripci贸n Requerida:</label>
          <select id="inscripcionRequeridaEvento">
        <option value="true">S铆</option>
        <option value="false">No</option>
          </select>
        </div>

        <div class="form-group">
          <label>URL Evento:</label>
          <input type="url" id="urlEvento">
        </div>

        <button type="submit" id="btnGuardarCambios" class="modal-button">Guardar</button>
        <button type="button" id="btnDemoEvento" class="modal-button" style="background:#888;margin-left:10px;">Demo</button>
      </form>
      <script>
        document.getElementById("btnDemoEvento").onclick = function() {
          const titulos = ["Feria de Innovaci贸n", "Congreso de Tecnolog铆a", "Taller de Creatividad", "Seminario de Ciencia"];
          const descripciones = [
        "Evento para compartir ideas innovadoras y conectar con expertos.",
        "Un congreso donde se presentan los 煤ltimos avances tecnol贸gicos.",
        "Taller pr谩ctico para fomentar la creatividad en equipos multidisciplinarios.",
        "Seminario sobre los retos actuales en ciencia y tecnolog铆a."
          ];
          const ubicaciones = ["Bucaramanga", "Virtual", "Universidad Industrial", "Centro de Convenciones"];
          const urls = [
        "https://evento-demo.com",
        "https://ctei-santander.org/evento",
        "https://innovacion2024.com",
        "https://ciencia-tec.org"
          ];
          const modalidad = ["presencial", "virtual", "hibrido"];
          function random(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
          function pad(n) { return n < 10 ? "0" + n : n; }
          const today = new Date();
          const fecha = today.getFullYear() + "-" + pad(today.getMonth() + 1) + "-" + pad(today.getDate());
          const horaInicio = pad(Math.floor(Math.random() * 8 + 8)) + ":00";
          const horaFin = pad(Math.floor(Math.random() * 3 + 16)) + ":00";
          document.getElementById("tituloEvento").value = random(titulos);
          document.getElementById("codigoEvento").value = "EVT" + Math.floor(Math.random() * 10000);
          document.getElementById("descripcionEvento").value = random(descripciones);
          document.getElementById("modalidadEvento").value = random(modalidad);
          document.getElementById("ubicacionEvento").value = random(ubicaciones);
          document.getElementById("fechaEvento").value = fecha;
          document.getElementById("horaInicioEvento").value = horaInicio;
          document.getElementById("horaFinEvento").value = horaFin;
          document.getElementById("cupoMaximoEvento").value = Math.floor(Math.random() * 100 + 20);
          document.getElementById("inscripcionRequeridaEvento").value = Math.random() > 0.5 ? "true" : "false";
          document.getElementById("urlEvento").value = random(urls);
        };
      </script>

    </div>
  </div>

  <!-- Scripts finales -->
  <script src="/js/nav.js"></script>
  <script src="/js/notificaciones.js"></script>
  <script src="/js/websocket.js"></script>
  <script src="/js/menuGeneral.js"></script>


  <!-- ========================== -->
  <!-- LGICA DE EVENTOS          -->
  <!-- ========================== -->
  <script>

    // -----------------------------------------
    // Cerrar Sesi贸n
    // -----------------------------------------
    document.getElementById("cerrarSesion").onclick = () => {
      Swal.fire({
        title: "驴Cerrar sesi贸n?",
        icon: "warning",
        showCancelButton: true
      }).then(r => {
        if (r.isConfirmed) {
          document.cookie = "jwt=; Path=/; Expires=Thu, 01 Jan 1970";
          document.cookie = "user=; Path=/; Expires=Thu, 01 Jan 1970";
          document.cookie = "userId=; Path=/; Expires=Thu, 01 Jan 1970";
          location.href = "/";
        }
      });
    };

    // -----------------------------------------
    // Cargar Eventos
    // -----------------------------------------
    async function cargarEventos(url = "/api/convocatorias") {
      try {
        const resp = await fetch(url);
        const data = await resp.json();

        const cont = document.getElementById("eventos");
        cont.innerHTML = "";

        data.forEach(ev => {

          if (ev.tipoConvocatoriaId !== 2 || !ev.habilitado) return;

          const card = document.createElement("div");
          card.className = "convocatorias-container";

          card.innerHTML = `
            <div class="convocatorias-card">
              <div class="convocatoria-header">
                <img src="${ev.urlImagen || 'img/sinfoto.jpg'}" class="evento-imagen">

                <div>
                  <h3>${ev.titulo}</h3>
                  <p>C贸digo: ${ev.codigo}</p>
                  <p>Modalidad: ${ev.modalidad}</p>
                  <p>Ubicaci贸n: ${ev.ubicacion}</p>
                  <p>Fecha: ${ev.fecha ? new Date(ev.fecha).toLocaleDateString() : ''}</p>
                  <p>Hora: ${ev.horaInicio} - ${ev.horaFin}</p>
                  <p>Cupo: ${ev.cupoMaximo || 'Sin l铆mite'}</p>
                  <p>Inscripci贸n: ${ev.inscripcionRequerida ? "S铆" : "No"}</p>
                </div>
              </div>

              <div class="lateral-derecho">
                <a href="${ev.urlConvocatoria}" target="_blank" class="action-button">Ver m谩s</a>
              </div>
            </div>
          `;

          cont.appendChild(card);
        });

      } catch (err) {
        document.getElementById("eventos").innerHTML = "Error al cargar eventos";
      }
    }

    // -----------------------------------------
    // Filtros
    // -----------------------------------------
    document.getElementById("buscarEvento").oninput = () => aplicarFiltros();
    document.getElementById("estadoFiltro").onchange = () => aplicarFiltros();

    function aplicarFiltros() {
      const nombre = document.getElementById("buscarEvento").value;
      const estado = document.getElementById("estadoFiltro").value;

      const params = [];
      if (nombre) params.push(`nombre=${encodeURIComponent(nombre)}`);
      params.push(`tipo=2`);
      if (estado) params.push(`estado=${estado}`);

      cargarEventos(`/api/convocatorias?${params.join("&")}`);
    }

    // -----------------------------------------
    // Mostrar Modal Nuevo
    // -----------------------------------------
    document.getElementById("btnNuevoEvento").onclick = () => {
      selectedFile = null;
      document.getElementById("previewImagenEvento").src = "";
      document.getElementById("formEditarEvento").reset();
      document.getElementById("modalEdicion").style.display = "block";
    };

    document.getElementById("closeModalEdicion").onclick = () =>
      document.getElementById("modalEdicion").style.display = "none";

    // -----------------------------------------
    // Guardar Evento (con archivo)
    // -----------------------------------------
    document.getElementById("formEditarEvento").onsubmit = async (e) => {
      e.preventDefault();

      const fd = new FormData();
      const userId = document.cookie.split("userId=")[1]?.split(";")[0];

      fd.append("userId", userId);
      fd.append("tipoConvocatoriaId", 2);
      fd.append("titulo", tituloEvento.value);
      fd.append("codigo", codigoEvento.value);
      fd.append("descripcion", descripcionEvento.value);
      fd.append("modalidad", modalidadEvento.value);
      fd.append("ubicacion", ubicacionEvento.value);
      fd.append("fecha", fechaEvento.value);
      fd.append("horaInicio", horaInicioEvento.value);
      fd.append("horaFin", horaFinEvento.value);
      fd.append("cupoMaximo", cupoMaximoEvento.value);
      fd.append("inscripcionRequerida", inscripcionRequeridaEvento.value);
      fd.append("urlConvocatoria", urlEvento.value);

      if (selectedFile) fd.append("fileImagenEvento", selectedFile);

      try {
        const resp = await fetch(`${API_BASE_URL}/api/eventos`, {
          method: "POST",
          body: fd
        });

        if (!resp.ok) throw await resp.json();

        Swal.fire("xito", "Evento creado correctamente", "success");
        document.getElementById("modalEdicion").style.display = "none";

      } catch (err) {
        Swal.fire("Error", err.message || "No se pudo crear el evento", "error");
      }
    };

    // Carga inicial
    cargarEventos();

  </script>

</body>

</html>
