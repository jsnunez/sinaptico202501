<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sinaptico - Innovaci√≥n Abierta</title>
  <link rel="stylesheet" href="styles/colores.css">

    <link rel="stylesheet" href="styles/innovacion.css">
    <link rel="stylesheet" href="styles/clasificados.css">
     <link rel="stylesheet" href="styles/menu.css">
    <link rel="stylesheet" href="styles/conocimiento.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body>

   <!-- Encabezado -->
    <header>
        <div class="header">
            <div onclick="window.location.href='/helice'">
                <!-- <span class="logo-icon">‚ö°</span> -->
                <img src="/img/logo1.png" alt="SINAPTICO" class="logo" style="height:8vh;">
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="font-size:1.5em;cursor:pointer;">
                    <span id="icono-notif">üîî <span
                            style='background:red;color:white;border-radius:50%;padding:2px 7px;font-size:0.9em;'>0</span></span>
                </div>
                <div class="notificaciones" id="notificaciones"></div>


                <div class="dropdown">
                    <button id="userMenuBtn" style="display: flex; align-items: center;">
                        <div id="userPhoto ">
                            <img class="imagenPerfil" id="imagenPerfilSecundaria" src="img/sinfoto.jpg"
                                alt="Foto de perfil" onerror="this.onerror=null;this.src='img/sinfoto.jpg';">

                        </div>
                        <h3 id="nombreUsuarioHeader" style="color:white; margin-left:10px;">Usuario <i
                                class="bi bi-chevron-down"></i> </h3>
                    </button>

                    <div class="dropdown-menu" id="userMenu">
                        <a class="perfilUser" id="perfilUser">Perfil</a>
                        <a href="/miEntidad" id="habilitarMiEmpresa" style="display: none;">Empresa</a>
                        <a href="#" id="cerrarSesion">Cerrar sesi√≥n</a>
                    </div>
                </div>
            </div>
        </div>
        <nav class="nav">

            <button class="nav-button" data-link="/helice" id="inicio"
                onclick="window.location.href='/helice'">Inicio</button>

            <div class="dropdown menuG">
                <button class="nav-button dropdown-btnG" data-link="/directorio">Directorio</button>
                <div class="dropdown-menu dropdown-menuG">
                    <a href="/directorio">Entidades</a>
                    <a href="/directorioPersonas">Personas</a>
                </div>
            </div>
            <div class="dropdown menuG">
                <button class="nav-button dropdown-btnG" data-link="/innovacion">Innovaci√≥n Abierta</button>
                <div class="dropdown-menu dropdown-menuG">
                    <a href="/retosEmpresariales">Retos Empresariales</a>
                    <a href="/innovacion">Muro de servicios</a>
                </div>
            </div>

            <div class="dropdown menuG">
                <button class="nav-button dropdown-btnG" data-link="/conocimiento">Conocimiento Abierto</button>
                <div class="dropdown-menu dropdown-menuG">
                    <a onclick="irEnConstruccion()">Cursos</a>
                    <a onclick="irEnConstruccion()">Biblioteca</a>
                </div>
            </div>
            <button class="nav-button" onclick="window.location.href='/convocatorias'">Convocatorias</button>

            <button class="nav-button" onclick="window.location.href='/eventos'">Eventos</button>
        </nav>

    </header>




  <!-- clasificados Section -->
  <section id="clasificados" class="main-content" style="display: block; margin-top: 3rem;">
       
    <div class="main-content">


      <section class="page-title">
        <h1>Muro de Servicios</h1>
      </section>

      <!-- Selector de tipo de servicio -->
      <div class="service-type-selector">
        <button class="service-type-btn active" data-type="offer">
          <i class="fas fa-hand-holding-usd"></i> Ofrecer mi servicio
        </button>
        <button class="service-type-btn" data-type="request">
          <i class="fas fa-search-dollar"></i> Solicitar servicios
        </button>


      </div>

      <div class="view-toggle">
        <button id="toggleViewBtn" class="btn">üìÉ Lista</button>

      </div>

      <!-- Filtros y controles -->
      <div class="board-controls">
        <div class="filter-tags">
          <span class="tag active" data-filter="all">Todos</span>
          <span class="tag" data-filter="dise√±o">Dise√±o</span>
          <span class="tag" data-filter="desarrollo">Desarrollo</span>
          <span class="tag" data-filter="marketing">Marketing</span>
          <span class="tag" data-filter="redacci√≥n">Redacci√≥n</span>
        </div>
        <div class="filter-tags">
          <span class="tag" data-filter="recent">Recientes</span>
          <span class="tag" data-filter="popular">Populares</span>
          <span class="tag" data-filter="featured">Destacados</span>
        </div>
      </div>

      <!-- Muro de clasificados -->
      <div class="classified-wall" id="classified-wall">
        <!-- Los clasificados se cargar√°n aqu√≠ din√°micamente -->
      </div>

    </div>
  </section>

  <!-- Create classified modal -->
  <div class="modal-backdrop" id="create-classified-modal">
    <div class="modalClasificado">
      <div class="modal-header">
        <h2 class="modal-title">Publicar un nuevo clasificado</h2>
        <p class="modal-description">Completa el formulario para publicar tu clasificado.</p>
      </div>
      <div class="modal-body">
        <form id="create-classified-form">
          <div class="form-group">
            <label for="classified-title" class="form-label">T√≠tulo del clasificado</label>
            <input type="text" id="classified-title" class="form-input" placeholder="Ej: Dise√±o de logotipo profesional"
              required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="classified-category" class="form-label">Categor√≠a</label>
              <select id="classified-category" class="form-select" required>
                <option value="">Seleccionar categor√≠a</option>
                <option value="Dise√±o gr√°fico">Dise√±o gr√°fico</option>
                <option value="Desarrollo web">Desarrollo web</option>
                <option value="Marketing digital">Marketing digital</option>
                <option value="Redacci√≥n">Redacci√≥n</option>
                <option value="Traducci√≥n">Traducci√≥n</option>
                <option value="Video y animaci√≥n">Video y animaci√≥n</option>
                <option value="M√∫sica y audio">M√∫sica y audio</option>
                <option value="Programaci√≥n">Programaci√≥n</option>
                <option value="Negocios">Negocios</option>
                <option value="Estilo de vida">Estilo de vida</option>
              </select>
            </div>

            <div class="form-group">
              <label for="classified-price" class="form-label">Precio/Presupuesto (COP)</label>
              <input type="text" id="classified-price" class="form-input" placeholder="Ej: 100000" required>
            </div>
          </div>

          <div class="form-group">
            <label for="classified-description" class="form-label">Descripci√≥n</label>
            <textarea id="classified-description" class="form-input form-textarea"
              placeholder="Describe detalladamente tu servicio o solicitud..." required></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="classified-delivery" class="form-label">Tiempo de entrega</label>
              <select id="classified-delivery" class="form-select" required>
                <option value="">Seleccionar tiempo</option>
                <option value="24 horas">24 horas</option>
                <option value="3 d√≠as">3 d√≠as</option>
                <option value="7 d√≠as">7 d√≠as</option>
                <option value="14 d√≠as">14 d√≠as</option>
                <option value="30 d√≠as o m√°s">30 d√≠as o m√°s</option>
              </select>
            </div>

            <div class="form-group">
              <label for="classified-location" class="form-label">Ubicaci√≥n</label>
              <input type="text" id="classified-location" class="form-input" placeholder="Ej: Bucaramanga,Colombia"
                required>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancel-classified-btn">Cancelar</button>
        <button class="btn btn-primary" id="submit-classified-btn">Publicar clasificado</button>
      </div>
    </div>
  </div>

  <!-- Contact classified modal -->
  <div class="modal-backdrop" id="contact-classified-modal">
    <div class="modalClasificado">
      <div class="modal-header">
        <h2 class="modal-title">Contactar por este clasificado</h2>
        <p class="modal-description">Est√°s contactando por: <span id="contact-classified-title"
            class="font-medium"></span></p>
      </div>
      <div class="modal-body">
        <form id="contact-classified-form">
          <div class="form-group">
            <label for="contact-name" class="form-label">Nombre completo</label>
            <input type="text" id="contact-name" class="form-input" placeholder="Tu nombre completo" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="contact-email" class="form-label">Correo electr√≥nico</label>
              <input type="email" id="contact-email" class="form-input" placeholder="tu@email.com" required>
            </div>

            <div class="form-group">
              <label for="contact-phone" class="form-label">Tel√©fono</label>
              <input type="text" id="contact-phone" class="form-input" placeholder="+57 600 000 000">
            </div>
          </div>

          <div class="form-group">
            <label for="contact-message" class="form-label">Mensaje</label>
            <textarea id="contact-message" class="form-input form-textarea"
              placeholder="Escribe tu mensaje o propuesta..." required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancel-contact-btn">Cancelar</button>
        <button class="btn btn-primary" id="submit-contact-btn">Enviar mensaje</button>
      </div>
    </div>
  </div>


  <div id="modalCrearReto" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 style="text-align: center;">Nuevo Reto</h2>
      <form id="crearRetoForm">
        <div class="form-section">
          <div class="input-box ">
            <label for="nombre">Nombre del Reto:</label>
            <input type="text" id="nombre" name="nombre" required>

            <label for="ubicacionVideo">Video promotor:</label>
            <input type="file" id="video" name="video" accept="video/*">

            <label for="descripcion">Descripci√≥n:</label>
            <textarea id="descripcion" name="descripcion"></textarea>

            <label for="ubicacionFicha">Ficha de Requisitos:</label>
            <input type="file" id="ficha" name="ficha" accept=".pdf,.doc,.docx">
          </div>
        </div>
        <button type="submit" class="modal-button">Crear Reto</button>

      </form>
    </div>
  </div>
  <!-- Spinner de carga de p√°gina -->
  <div id="page-spinner-overlay" aria-hidden="true" role="status" aria-label="Cargando">
    <div class="spinner" aria-hidden="true"></div>
    <div class="spinner-text">Cargando...</div>
  </div>
  <script src="/js/config.js"></script>

  <script src="js/retos.js"></script>
  <script src="js/clasificadosMostrar.js"></script>
  <script src="js/ContactarServicio.js"></script>
  <script src="js/notificaciones.js"></script>
  <script src="/js/websocket.js"></script>
   <script src="/js/menu.js"></script>
  
  <!-- Formulario de clasificados -->
  <script>

    const priceInput = document.getElementById('classified-price');

    priceInput.addEventListener('input', (e) => {
      // Captura solo d√≠gitos
      let raw = e.target.value.replace(/\D/g, '');

      // Evita errores si est√° vac√≠o
      if (!raw) {
        e.target.value = '';
        return;
      }

      // Formatea con separadores de miles
      const formatted = raw.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      e.target.value = formatted;
    });

    // Eliminar puntos antes de enviar al servidor
    document.querySelector('form').addEventListener('submit', (e) => {
      const input = document.getElementById('classified-price');
      input.value = input.value.replace(/\./g, ''); // Enviar n√∫mero limpio al backend
    });
  </script>


  <!-- En construccion -->
  <script>
    function irEnConstruccion() {
      window.location.href = "/construccion"; // o la ruta que tengas
    }

    const toggleViewBtn = document.getElementById('toggleViewBtn');
    const classifiedWall = document.querySelector('.classified-wall');

    toggleViewBtn.addEventListener('click', () => {
      const isList = classifiedWall.classList.toggle('list-view');

      // Cambiar √≠cono/texto seg√∫n el modo actual
      toggleViewBtn.textContent = isList ? 'üü¶ Cuadr√≠cula' : 'üìÉ Lista';
    });


    
    const gridBtn = document.getElementById('gridViewBtn');
    const listBtn = document.getElementById('listViewBtn');
    const wall = document.querySelector('.classified-wall');


    document.addEventListener("DOMContentLoaded", async function () {

      const usuario = obtenerCookie("user");
      const userId = obtenerCookie("userId");
      const userData = cargarDatosUsuario(userId);
      console.log(userData.fotoPerfil);
      // ‚úÖ Verificaci√≥n de cookies
      if (!usuario || !userId) {
        document.getElementById('bienvenido').innerText = "Error: No se encontr√≥ la informaci√≥n del usuario.";
        return;
      }

      // ‚úÖ Limpieza del nombre del usuario
      let cleanedStr = decodeURIComponent(usuario.replace(/%20/g, " "));
      let nombreUsuario = cleanedStr.split(" ")[0];

      try {
        const response = await fetch(`${API_BASE_URL}/api/entidad/verificar-entidad/${userId}`);
        const data = await response.json();
        console.log(data);
        if (data.success && data.entidad && data.entidad.UserAdminId) {
          idEntidad = data.entidad.id;

          const estado = data.entidad.habilitado == 1 ? "Habilitado" : "Deshabilitado (estamos revisando tus datos)";

          document.getElementById("crearReto").style.display = data.entidad.habilitado == 1 ? "block" : "none";
          // document.getElementById("editarEntidad").style.display = data.entidad.habilitado == 1 ? "block" : "none";
          // document.getElementById("asignarServicio").style.display = data.entidad.habilitado == 1 ? "block" : "none";
          document.getElementById("vincularEntidad").style.display = "none";
          document.getElementById('bienvenido').innerText =
            `Hola ${nombreUsuario}, eres el administrador de ${data.entidad.razonSocial}. Actualmente tu estado es: ${estado}`;


        } else {
          // ‚úÖ Verificar si pertenece a una entidad como usuarioempresa
          const usuarioData = await verificarUsuarioEntidad(userId);
          console.log(usuarioData)

          if (usuarioData.length > 0) {
            document.getElementById('bienvenido').innerText =
              `Hola ${nombreUsuario},  Tu eres ${usuarioData[0].Cargo.nombre} del actor ${usuarioData[0].empresa.razonSocial} tu estado es
           ${usuarioData[0].estado == 1 ? "Habilitado" : "Deshabilitado (contacta con el administrador de la entidad)"}`;
            document.getElementById("vincularEntidad").style.display = "none";
          } else {
            document.getElementById('bienvenido').innerText =
              `Hola ${nombreUsuario}, no est√°s unido a ninguna entidad.`;
          }
        }
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('bienvenido').innerText =
          "Ocurri√≥ un error al verificar tu entidad. Por favor intenta m√°s tarde.";
      }
    });



    async function cargarDatosUsuario(userId) {
      const response = await fetch(`${API_BASE_URL}/api/user/${userId}`);
      const data = await response.json();

      document.getElementById("imagenPerfilSecundaria").src = data.fotoPerfil ? "photo/" + data.fotoPerfil : "photo/sinfoto.jpg";
      document.getElementById("imagenPerfil").src = data.fotoPerfil ? "photo/" + data.fotoPerfil : "photo/sinfoto.jpg";


      console.log(data);
      return data;
    }

    document.getElementById("crearReto").addEventListener("click", function () {
      document.getElementById("modalCrearReto").style.display = "block";
    });

    document.querySelector("#modalCrearReto .close").addEventListener("click", function () {
      document.getElementById("modalCrearReto").style.display = "none";
    });

    // ‚úÖ Funci√≥n para verificar si el usuario pertenece a una entidad
    async function verificarUsuarioEntidad(userId) {
      const response = await fetch(`${API_BASE_URL}/api/usuarioempresa/user/${userId}`);
      const data = await response.json();
      return data; // { exists: true, entidad: {...} }
    }
  </script>
  <!-- Cerrar Sesion -->
  <script>
    document.getElementById("cerrarSesion").addEventListener("click", () => {
      Swal.fire({
        title: '¬øEst√°s seguro?',
        text: '¬øQuieres cerrar sesi√≥n?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, cerrar sesi√≥n',
        cancelButtonText: 'Cancelar',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          // Borrar cookies y redirigir
          document.cookie = 'jwt=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          document.cookie = 'user=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          document.cookie = 'userId=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
          document.location.href = "/";

        }
        // Si el usuario cancela, no pasa nada
      });
    });

  </script>
  <!-- Men√∫ Desplegable -->
  <script>
    const userMenuBtn = document.getElementById("userMenuBtn");
    const dropdown = userMenuBtn.closest(".dropdown");

    // Mostrar / ocultar el men√∫ al hacer clic
    userMenuBtn.addEventListener("click", (event) => {
      event.stopPropagation(); // evita que el clic cierre inmediatamente el men√∫
      dropdown.classList.toggle("show");
    });

    // Cerrar el men√∫ si haces clic fuera
    document.addEventListener("click", () => {
      dropdown.classList.remove("show");
    });
  </script>


  <script>
    (function () {
      // Garantiza que el overlay permanezca al menos 5s desde que se ejecuta este script.
      const MIN_MS = 2000;
      const overlay = document.getElementById('page-spinner-overlay');
      if (!overlay) return;

      // Si ya pas√≥ m√°s de MIN_MS desde la navegaci√≥n start, aun as√≠ mostramos el overlay breve
      const start = performance.timing ? performance.timing.navigationStart : Date.now();
      const now = Date.now();
      const elapsed = Math.max(0, now - start);
      const remaining = Math.max(0, MIN_MS - elapsed);

      // Evita interacci√≥n mientras existe el overlay
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';

      setTimeout(() => {
        overlay.style.opacity = '0';
        // permitir scroll cuando hide completo
        setTimeout(() => {
          if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
          document.documentElement.style.overflow = '';
          document.body.style.overflow = '';
        }, 420);
      }, remaining);
    })();
  </script>
    <script>
        (function () {
            // Garantiza que el overlay permanezca al menos 5s desde que se ejecuta este script.
            const MIN_MS = 1000;
            const overlay = document.getElementById('page-spinner-overlay');
            if (!overlay) return;

            // Si ya pas√≥ m√°s de MIN_MS desde la navegaci√≥n start, aun as√≠ mostramos el overlay breve
            const start = performance.timing ? performance.timing.navigationStart : Date.now();
            const now = Date.now();
            const elapsed = Math.max(0, now - start);
            const remaining = Math.max(0, MIN_MS - elapsed);

            // Evita interacci√≥n mientras existe el overlay
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';

            setTimeout(() => {
                console.log('MIN_MS spinner:', MIN_MS);
                // permitir scroll cuando hide completo
                setTimeout(() => {
                    if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
                    document.documentElement.style.overflow = '';
                    document.body.style.overflow = '';
                }, 420);
            }, remaining);
        })();
    </script>

        <!-- Utilidades-->
    <script>
        // =========================
        // Utilidades
        // =========================
        function obtenerCookie(nombre) {
            const nombreCookie = `${nombre}=`;
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.indexOf(nombreCookie) === 0) {
                    return cookie.substring(nombreCookie.length, cookie.length);
                }
            }
            return null;
        }

        const userId = obtenerCookie("userId");

        // =========================
        // Inicializaci√≥n de usuario (nombre, foto) y carga de proyectos
        // =========================
        (async () => {
            try {
                // Cargar usuario (para cabecera y foto)
                const resUser = await fetch(`/api/user/${userId}`);
                const dataUser = await resUser.json();
                if (dataUser?.name) {

                    document.getElementById('nombreUsuarioHeader').innerText = ` ${dataUser.name.split(" ")[0]}`;
                }

                document.getElementById("imagenPerfilSecundaria").src = dataUser.fotoPerfil ? "photo/" + dataUser.fotoPerfil : "photo/sinfoto.jpg";

                if (dataUser?.fotoPerfil) {
                    const img = document.getElementById('imagenPerfil');
                    if (img) img.src = dataUser.fotoPerfil;
                }

                // Determinar entidad y setear input nombreEntidad
                let entidadId = null;
                const resUE = await fetch(`/api/usuarioempresa/user/${userId}`);
                const dataUE = await resUE.json();

                if (Array.isArray(dataUE) && dataUE.length > 0 && dataUE[0].empresa) {
                    entidadId = dataUE[0].empresa.id;
                } else {
                    entidadId = 'null';
                }

                const inputEntidad = document.getElementById('nombreEntidad');
                if (inputEntidad) inputEntidad.value = entidadId;

                console.log('Entidad ID seleccionada:', entidadId);


            } catch (err) {
                console.error('Error inicializando la vista:', err);
            }
        })();

    </script>

</body>

</html>