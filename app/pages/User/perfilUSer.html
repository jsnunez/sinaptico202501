<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SINAPTICO</title>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="styles/colores.css">
    <link rel="stylesheet" href="styles/perfil.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

</head>

<body>
    <!-- Encabezado -->
    <header class="header">
        <div onclick="window.location.href='/helice'" class="logo">
            <!-- <span class="logo-icon">‚ö°</span> -->
            <span class="logo-text">SINAPTICO</span>
        </div>
        <nav class="nav">
            <button class="nav-button pulse" onclick="window.location.href='/helice'">H√©lice</button>
            <button class="nav-button pulse" onclick="window.location.href='/proyectos'">Proyectos</button>
            <button class="nav-button pulse" onclick="window.location.href='/innovacion'">Innovaci√≥n</button>

            <button class="nav-button pulse" onclick="window.location.href='/Conocimiento'">Conocimiento</button>
            <button class="nav-button pulse" onclick="window.location.href='/convocatorias'">Convocatorias</button>

            <button class="nav-button pulse" onclick="window.location.href='/mapa-usuarios'">Mapa</button>

            <div style="position:fixed;top:10px;right:20px;z-index:1000;font-size:1.5em;cursor:pointer;">
                <span id="icono-notif">üîî <span
                        style='background:red;color:white;border-radius:50%;padding:2px 7px;font-size:0.9em;'>0</span></span>
            </div>
            <div class="notificaciones" id="notificaciones"></div>

            <!-- <button class="nav-button pulse" id="cerrarSesion">Cerrar sesi√≥n</button> -->
            <!-- Bot√≥n con men√∫ desplegable -->
            <div class="dropdown">
                <button class=" " id="userMenuBtn">
                    <div id="userPhoto ">
                        <img class="imagenPerfil" id="imagenPerfilSecundaria" src="img/sinfoto.jpg" alt="Foto de perfil"
                            onerror="this.onerror=null;this.src='img/sinfoto.jpg';">
                    </div>

                </button>

                <div class="dropdown-menu" id="userMenu">
                    <a href="/perfil">Perfil</a>
                    <a href="/configuracion">Configuraci√≥n</a>
                    <a href="#" id="cerrarSesion">Cerrar sesi√≥n</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Contenido principal - Datos Generales -->

    <div class="welcome-text">

        <h1 style="display: none;" id="departamentoPerfilValor"></h1>
        <h1 style="display: none;" id="ciudadPerfilValor"></h1>
        <!-- <p class="subtitle">Conectando entidades para potenciar la innovaci√≥n</p> -->
    </div>

    <div class="main-content" id="miPerfil">

        <div class="section">

            <!-- Columna izquierda: tabla -->
            <div class="input-box">


                <h2 class="tittle">Datos Generales</h2>

                <table class="table-perfil">
                    <tr>
                        <td>
                            <div id="userPhoto">
                                <img id="imagenPerfil" src="img/sinfoto.jpg" alt="Foto de perfil"
                                    onerror="this.onerror=null;this.src='img/sinfoto.jpg';">
                            </div>

                        </td>
                        <td id="">
                            <h3 id="MiNombreCompleto" style="text-transform: capitalize;"></h3>
                            <div>
                                <button class="nav-button" id="perfil">
                                    <span><i class="bi bi-pencil-square"></i> Perfil </span>

                                </button>

                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td><strong>Perfil Profesional:</strong></td>
                        <td id="MiPerfilProfesional"></td>
                    </tr>
                    <tr>
                        <td><strong>Tel√©fono:</strong></td>
                        <td id="MiTelefono"></td>
                    </tr>
                    <tr>
                        <td><strong>Ubicaci√≥n:</strong></td>
                        <td id="MiUbicacion"></td>
                    </tr>
                    <tr>
                        <td><strong>Correo Electr√≥nico:</strong></td>
                        <td id="MiCorreo"></td>
                    </tr>
                    <tr>
                        <td><strong>Vinculado a:</strong></td>
                        <td id="MiVinculado"></td>
                    </tr>
                </table>
                <br>

            </div>

            <!-- Columna derecha: PDF -->
            <div class="input-box">
                <iframe src="" width="100%" height="700px" style="display:none;"></iframe>

            </div>


            <!--Modal Actualizar Perfil-->

            <div id="modalPerfil" class="modal">
                <div class="modal-content" style="max-width:900px;">
                    <span class="close" id="cerrarModalPerfil">&times;</span>
                    <h2>Mi Perfil</h2>
                    <form id="formFotoPerfil">
                        <div class="form-section logo-preview-container"
                            style="text-align:center;display: flex; flex-direction: column;align-items: center;">
                            <label for="inputFotoPerfil" style="font-weight:500;color:#555;">Foto de perfil:</label>

                            <img id="previewFotoPerfil" src="" alt="Foto actual"
                                style="width:100px;height:100px;border-radius:50%;object-fit:cover;margin-bottom:15px;"
                                onerror="this.onerror=null;this.src='img/sinfoto.jpg';">
                            <input type="file" id="inputFotoPerfil" name="fotoPerfil" accept="image/*">
                        </div>
                        <div class="form-section">

                            <!--Actualizar Datos Generales-->
                            <h3 class="section-title">Datos Generales</h3>

                            <div class=" input-row">
                                <div class="input-box">
                                    <label for="nombrePerfil">Nombre</label>
                                    <input type="text" id="nombrePerfil" name="nombrePerfil" required>
                                </div>
                                <div class="input-box">
                                    <label for="telefonoPerfil">Tel√©fono / Celular</label>
                                    <input type="tel" id="telefonoPerfil" name="telefonoPerfil" required>
                                </div>


                            </div>

                            <div class="input-row">
                                <div class="input-box">
                                    <label for="departamentoPerfil">Departamento:</label>
                                    <select id="departamentoPerfil" name="departamentoPerfil" required>
                                        <option value="">Seleccione departamento</option>
                                        <!-- Opciones se cargar√°n din√°micamente -->
                                    </select>
                                </div>

                                <div class="input-box">
                                    <label for="ciudadPerfil">Ciudad:</label>
                                    <select id="ciudadPerfil" name="ciudadPerfil" required>
                                        <option value="">Seleccione ciudad</option>
                                        <!-- Opciones se cargar√°n din√°micamente -->
                                    </select>
                                </div>

                            </div>

                        </div>

                        <!--Actualizar CV-->
                        <div class="form-section">
                            <h3 class="section-title">Perfil profesional:</h3>

                            <div class="input-row">
                                <div class="input-box full-width">
                                    <label for="perfilProfesional">Describe tu perfil</label>
                                    <textarea id="perfilProfesional" name="perfilProfesional" required></textarea>
                                </div>
                                <div class="input-box">
                                    <label for="cvPdf" type="file">Hoja de Vida</label>
                                    <input type="file" id="cvPdf" name="cvPdf" accept="application/pdf">
                                </div>

                            </div>
                            <div class="modal-actions">
                                <button type="button" class="modal-button-secondary" id="cancelarActualizarPerfil">
                                    Cancelar
                                </button>
                                <button type="submit" class="modal-button" id="actualizarPerfil"> Guardar
                                    Cambios</button>

                            </div>

                        </div>

                    </form>
                </div>

            </div>

            <script>

                async function cargarDatosMiPerfil() {
                    try {
                        const userId = obtenerCookie("userId");
                        if (!userId) return;

                        const res = await fetch(`/api/user/${userId}`);
                        if (!res.ok) throw new Error('No se pudo obtener el perfil');
                        const data = await res.json();
                        console.log(data);
                        // Coloca los datos en los elementos correspondientes
                        document.getElementById('MiNombreCompleto').textContent = data.name || '';
                        document.getElementById('MiPerfilProfesional').textContent = data.perfilProfesional || '';
                        document.getElementById('MiTelefono').textContent = data.telefono || '';
                        document.getElementById('MiUbicacion').textContent = data.ciudad.nombre + ' - ' + data.ciudad.departamento.nombre || '';
                        document.getElementById('MiCorreo').textContent = data.email || '';

                        document.getElementById("imagenPerfilSecundaria").src = data.fotoPerfil ? "photo/" + data.fotoPerfil : "photo/sinfoto.jpg";
                        document.getElementById("imagenPerfil").src = data.fotoPerfil ? "photo/" + data.fotoPerfil : "photo/sinfoto.jpg";

                        // Cargar Datos para actualizar Perfil

                        document.getElementById("nombrePerfil").value = data.name || '';
                        document.getElementById("telefonoPerfil").value = data.telefono || '';
                        document.getElementById("perfilProfesional").value = data.perfilProfesional || '';
                    document.getElementById("previewFotoPerfil").src = data.fotoPerfil ? "photo/" + data.fotoPerfil : "photo/sinfoto.jpg";

                      
                        if (data.ciudadId) {
                            try {
                                const resp = await fetch(`/api/ciudades/ciudad/${data.ciudadId}`);
                                const ciudadData = await resp.json();
                                document.getElementById("departamentoPerfilValor").innerHTML = ciudadData.ciudad.departamentoId || '';
                            } catch (err) {
                                document.getElementById("departamentoPerfilValor").innerHTML = '';
                                console.error('Error al consultar el departamento:', err);
                            }
                        } else {
                            document.getElementById("departamentoPerfilValor").innerHTML = '';
                        }

                        document.getElementById("ciudadPerfilValor").innerHTML = data.ciudadId || '';



                        // Si tienes la URL del CV PDF (usando data.enlaceHojaDeVida)
                        if (data.enlaceHojaDeVida) {
                            const iframe = document.querySelector('iframe');
                            if (iframe) {
                                iframe.src = "CV/" + data.enlaceHojaDeVida;
                                iframe.style.display = 'block';
                            }
                        }

                    } catch (err) {
                        console.error('Error cargando datos de usuario:', err);
                    }

                    // Verificar si hay una entidad asociada al usuario
                    try {
                        const entidadRes = await fetch(`/api/entidad/verificar-entidad/${userId}`);
                        if (entidadRes.ok) {
                            const entidadData = await entidadRes.json();
                            console.log('Entidad asociada:', entidadData.success);
                            // Si hay entidad asociada, muestra el nombre, si no, muestra "Sin entidad asociada"
                            if (entidadData.success) {
                                console.log('Entidad asociada:', entidadData.entidad.razonSocial);
                                var entidadNombre = entidadData.entidad.razonSocial;
                            } else {
                                console.log('Entidad asociada: Sin entidad asociada');
                                var entidadNombre = "Sin entidad asociada";
                            }
                            // Busca la celda correspondiente y actualiza el texto
                            document.getElementById('MiVinculado').textContent = entidadNombre;
                        }
                    } catch (e) {
                        console.error('Error verificando entidad asociada:', e);
                    }
                }
                // Funci√≥n para obtener el valor de una cookie por su nombre
                function obtenerCookie(nombre) {
                    const nombreCookie = `${nombre}=`;
                    const cookies = document.cookie.split(';');

                    for (let i = 0; i < cookies.length; i++) {
                        let cookie = cookies[i].trim();

                        if (cookie.indexOf(nombreCookie) === 0) {
                            return cookie.substring(nombreCookie.length, cookie.length);
                        }
                    }

                    return null; // Retorna null si no se encuentra la cookie
                }
                // Llama a la funci√≥n al cargar la p√°gina
                window.addEventListener('DOMContentLoaded', cargarDatosMiPerfil);
            </script>

            <script>
                const userMenuBtn = document.getElementById("userMenuBtn");
                const dropdown = userMenuBtn.closest(".dropdown");

                // Mostrar / ocultar el men√∫ al hacer clic
                userMenuBtn.addEventListener("click", (event) => {
                    event.stopPropagation(); // evita que el clic cierre inmediatamente el men√∫
                    dropdown.classList.toggle("show");
                });

                // Cerrar el men√∫ si haces clic fuera
                document.addEventListener("click", () => {
                    dropdown.classList.remove("show");
                });
            </script>

            <script>
                document.getElementById("cerrarSesion").addEventListener("click", () => {
                    Swal.fire({
                        title: '¬øEst√°s seguro?',
                        text: '¬øQuer√©s cerrar sesi√≥n?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'S√≠, cerrar sesi√≥n',
                        cancelButtonText: 'Cancelar',
                        reverseButtons: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Borrar cookies y redirigir
                            document.cookie = 'jwt=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                            document.cookie = 'user=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                            document.cookie = 'userId=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                            document.location.href = "/";

                        }
                        // Si el usuario cancela, no pasa nada
                    });
                });

            </script>
            <script>

                // Abrir formulario actualizar de perfil al hacer clic en el bot√≥n
                document.getElementById('perfil').onclick = function () {
                    document.getElementById('modalPerfil').style.display = 'block';

                };
                document.getElementById('cerrarModalPerfil').onclick = function () {
                    document.getElementById('modalPerfil').style.display = 'none';
                };
                // Vista previa de la imagen seleccionada
                document.getElementById('inputFotoPerfil').onchange = function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('previewFotoPerfil').src = URL.createObjectURL(file);
                    }
                };
                // Guardar foto (debes implementar la l√≥gica de subida en tu backend)
                document.getElementById('formFotoPerfil').onsubmit = async function (e) {
                    e.preventDefault();

                    const userId = obtenerCookie("userId");
                    const file = document.getElementById('inputFotoPerfil').files[0];
                    const name = document.getElementById('nombrePerfil').value.trim();
                    const telefono = document.getElementById('telefonoPerfil').value.trim();
                    const ciudadId = parseInt(document.getElementById('ciudadPerfil').value, 10) || null;
                    const perfilProfesional = document.getElementById('perfilProfesional').value.trim() || null;

                    try {
                        // 1) Si hay archivo, sube la foto
                        if (file) {
                            const formData = new FormData();
                            formData.append('fotoPerfil', file);
                            // opcional: puedes mostrar un loader
                            const resFoto = await fetch(`/api/user/cambiarFoto/${userId}`, {
                                method: 'PUT',
                                body: formData
                            });
                            if (!resFoto.ok) {
                                const err = await resFoto.text().catch(() => '');
                                throw new Error(`Error al subir la foto. ${err}`);
                            }
                        }

                        // 2) Actualiza el perfil SIEMPRE (independiente de si hubo foto o no)
                        const resPerfil = await fetch(`/api/user/actualizarPerfil/${userId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name,
                                telefono,
                                ciudadId,
                                perfilProfesional
                            })
                        });
                        if (!resPerfil.ok) {
                            const err = await resPerfil.text().catch(() => '');
                            throw new Error(`Error al actualizar el perfil. ${err}`);
                        }

                        // 3) Cierra modal y refresca (o actualiza s√≥lo la imagen y los textos si prefieres)
                        // Subir CV si se seleccion√≥ archivo PDF
                        const cvFile = document.getElementById('cvPdf').files[0];
                        if (cvFile) {
                            const cvFormData = new FormData();
                            cvFormData.append('cvPdf', cvFile);
                            const resCV = await fetch(`/api/user/cambiarCv/${userId}`, {
                                method: 'PUT',
                                body: cvFormData
                            });
                            if (!resCV.ok) {
                                const err = await resCV.text().catch(() => '');
                                throw new Error(`Error al subir la hoja de vida. ${err}`);
                            }
                        }
                        document.getElementById('modalPerfil').style.display = 'none';
                        document.cookie = `user=${encodeURIComponent(name)}; path=/;`;
                        Swal.fire({
                            icon: 'success',
                            title: 'Perfil actualizado',
                            text: 'Tus datos se han guardado correctamente.',
                            timer: 1800,
                            showConfirmButton: false
                        }).then(() => {
                            location.reload(); // O actualiza s√≥lo la foto y los textos
                        });
                    } catch (err) {
                        console.error(err);
                        alert(err.message || 'Ocurri√≥ un error al actualizar el perfil.');
                    }
                };

            </script>

            <script>
                // Funci√≥n para obtener departamentos desde la API
                async function obtenerDepartamentosColombia() {
                    try {
                        const res = await fetch('/api/departamentos');
                        const data = await res.json();
                        return data.departamentos || [];
                    } catch (err) {
                        console.error('Error obteniendo departamentos:', err);
                        return [];
                    }
                }


                // Funci√≥n para agregar departamentos al select
                async function agregarDepartamentosPerfil() {
                    const departamentos = await obtenerDepartamentosColombia();
                    const depSelect = document.getElementById('departamentoPerfil');
                    depSelect.innerHTML = '<option value="">Seleccione departamento</option>';
                    if (depSelect && departamentos && departamentos.length > 0) {
                        departamentos.forEach(dep => {
                            const option = document.createElement('option');
                            option.value = dep.id;
                            option.textContent = dep.nombre;
                            depSelect.appendChild(option);
                        });
                    } else {
                        console.warn('No se encontraron Departamentos para cargar.');
                    }

                    // Si ya tienes el departamento y ciudad del usuario, puedes preseleccionarlos aqu√≠
                    const departamentoId = document.getElementById('departamentoPerfilValor').textContent;
                    // Si departamentoId es un n√∫mero diferente de 0, selecciona ese departamento en el select
                    if (departamentoId && !isNaN(departamentoId) && Number(departamentoId) !== 0) {
                        depSelect.value = departamentoId;
                        await cargarCiudadesPerfil(departamentoId);
                    }
                }

                // Funci√≥n para cargar ciudades seg√∫n departamento seleccionado
                async function cargarCiudadesPerfil(departamentoId) {
                    const ciudadSelect = document.getElementById('ciudadPerfil');
                    ciudadSelect.innerHTML = '<option value="">Seleccione ciudad</option>';
                    if (!departamentoId) return;
                    try {
                        const res = await fetch(`/api/ciudades/${departamentoId}`);
                        const data = await res.json();
                        if (data.ciudades && data.ciudades.length > 0) {
                            data.ciudades.forEach(ciudad => {
                                const option = document.createElement('option');
                                option.value = ciudad.id;
                                option.textContent = ciudad.nombre;
                                ciudadSelect.appendChild(option);
                            });
                        }
                    } catch (err) {
                        console.error('Error obteniendo ciudades:', err);
                    }
                    // Si ya tienes la ciudad del usuario, puedes preseleccionarla aqu√≠
                    const ciudadId = document.getElementById('ciudadPerfilValor').textContent;
                    if (ciudadId && !isNaN(ciudadId) && Number(ciudadId) !== 0) {
                        ciudadSelect.value = ciudadId;
                    }

                }

                // Inicializar departamentos al mostrar el modal
                document.getElementById('perfil').onclick = function () {
                    document.getElementById('modalPerfil').style.display = 'block';
                    agregarDepartamentosPerfil();

                };

                // Cambiar ciudades al seleccionar departamento
                document.getElementById('departamentoPerfil').onchange = function () {
                    cargarCiudadesPerfil(this.value);
                };
            </script>


            <script src="js/notificaciones.js"></script>
            <script src="/js/websocket.js"></script>


            <!-- <script src="/js/cargarProyectos.js"></script> -->


</body>

</html>