<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SINAPTICO</title>

  <link rel="stylesheet" href="styles/colores.css">
  <link rel="stylesheet" href="styles/stylehelice2.css">
  <link rel="stylesheet" href="styles/desplegables.css">
  <link rel="stylesheet" href="styles/menu.css">
  <link rel="stylesheet" href="styles/postulaciones.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Leaflet.js para mapas -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>


  <!-- Encabezado -->
  <header>
    <div class="header">
      <div onclick="window.location.href='/helice'">
        <!-- <span class="logo-icon">‚ö°</span> -->
        <img src="/img/logo1.png" alt="SINAPTICO" class="logo" style="height:8vh;">
      </div>
      <div style="display: flex; align-items: center; gap: 20px;">
        <div style="font-size:1.5em;cursor:pointer;">
          <span id="icono-notif">üîî <span
              style='background:red;color:white;border-radius:50%;padding:2px 7px;font-size:0.9em;'>0</span></span>
        </div>
        <div class="notificaciones" id="notificaciones"></div>


        <div class="dropdown">
          <button id="userMenuBtn" style="display: flex; align-items: center;">
            <div id="userPhoto ">
              <img class="imagenPerfil" id="imagenPerfilSecundaria" src="img/sinfoto.jpg" alt="Foto de perfil"
                onerror="this.onerror=null;this.src='img/sinfoto.jpg';">

            </div>
            <h3 id="nombreUsuarioHeader" style="color:white; margin-left:10px;">Usuario <i
                class="bi bi-chevron-down"></i> </h3>
          </button>

          <div class="dropdown-menu" id="userMenu">
            <a class="perfilUser" id="perfilUser">Perfil</a>
            <a id="habilitarMiEmpresa" style="display: none;">Empresa</a>
            <a href="#" id="cerrarSesion">Cerrar sesi√≥n</a>
          </div>
        </div>
      </div>
    </div>
    <nav class="nav">

      <button class="nav-button" data-link="/helice" id="inicio"
        onclick="window.location.href='/helice'">Inicio</button>

      <div class="dropdown menuG">
        <button class="nav-button dropdown-btnG" data-link="/directorio">Directorio</button>
        <div class="dropdown-menu dropdown-menuG">
          <a href="/directorio">Entidades</a>
          <a href="/directorioPersonas">Personas</a>
        </div>
      </div>
      <button class="nav-button" onclick="window.location.href='/proyectos'" data-link="/proyectos">Proyectos</button>
      <button class="nav-button" onclick="window.location.href='/ofertaRegional'" data-link="/ofertaRegional">Oferta
        Regional</button>
      <div class="dropdown menuG">
        <button class="nav-button dropdown-btnG" data-link="/retos">Innovaci√≥n Abierta</button>
        <div class="dropdown-menu dropdown-menuG">
          <a href="/retosEmpresariales">Retos Empresariales</a>
          <a href="/retosAula">Retos de Aula</a>
        </div>
      </div>

      <div class="dropdown menuG">
        <button class="nav-button dropdown-btnG" data-link="/conocimiento">Conocimiento Abierto</button>
        <div class="dropdown-menu dropdown-menuG">
          <a href="/conocimientoCursosVirtuales" data-link="/cursosVirtuales">Cursos</a>
          <a href="/conocimientoBiblioteca" data-link="/conocimientoBiblioteca">Biblioteca</a>
        </div>
      </div>
      <button class="nav-button" onclick="window.location.href='/convocatorias'">Convocatorias</button>

      <button class="nav-button" onclick="window.location.href='/eventos'">Eventos</button>

      <button class="nav-button" id="btnEvaluador" style="display: none;" data-link="/portalEvaluadorUser"
        onclick="window.location.href='/portalEvaluadorUser'">Evaluaci√≥n</button>

    </nav>

  </header>
  <!-- Spinner de carga de p√°gina -->
  <div id="page-spinner-overlay" aria-hidden="true" role="status" aria-label="Cargando">
    <div class="spinner" aria-hidden="true"></div>
    <div class="spinner-text">Cargando...</div>
  </div>

  <!-- Crear nueva idea PPI-->
  <div id="modalPostulaciones" class="modal">
    <div class="modal-content" style="max-width:900px;">
      <span class="close" id="cerrarModalPostulaciones">&times;</span>
      <h2>Ficha T√©cnica de PPI</h2>
      <div class="form-section">
        <h3 class="section-title">Contacto L√≠der PPI</h3>
        <div class="input-box full-width">
          <label for="Entidad">Nombre de la Instituci√≥n responsable </label>
          <input disabled type="text" id="nombreEntidad" name="nombreEntidad" required>
        </div>

        <div class=" input-row">

          <div class="input-box">
            <label for="nombreLider">Nombre y Cargo</label>
            <input type="text" id="nombreLider" name="nombreLider" placeholder="Ingrese el nombre del L√≠der PPI"
              required>
          </div>
          <div class="input-box">
            <label for="telefonoLider">Tel√©fono / Celular</label>
            <input disabled="true" type="text" id="telefonoLider" name="telefonoLider"
              placeholder="Ingrese el tel√©fono o celular" required>
          </div>

        </div>

        <div class="input-row">
          <div class="input-box full-width">
            <label for="correoLider">Correo Electr√≥nico</label>
            <input disabled="true" type="email" id="correoLider" name="correo" placeholder="Ingrese el correo" required>
          </div>



        </div>

      </div>

      <!-- Contacto de la persona que diligencia la ficha
            <div class="form-section">
                <h3 class="section-title">Contacto de quien diligencia la ficha</h3>
                <div class="input-box full-width">
                    <label for="EntidadDiligencia">Nombre de la Instituci√≥n responsable </label>
                    <input type="text" id="nombreEntidad" name="nombreEntidad"
                        placeholder="Ingrese el nombre de la entidad responsable" required>
                </div>

                <div class=" input-row">
                    <div class="input-box">
                        <label for="nombreDiligenciador">Nombre</label>
                        <input type="text" id="nombreDiligenciador" name="nombreDiligenciador"
                            placeholder="Ingrese el nombre de quien diligencia la ficha" required>
                    </div>
                    <div class="input-box">
                        <label for="cargoDiligenciador">Cargo</label>
                        <input type="text" id="cargoDiligenciador" name="cargoDiligenciador"
                            placeholder="Ingrese el cargo quien diligencia la ficha" required>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-box">
                        <label for="correoDiligenciador">Correo Electr√≥nico</label>
                        <input type="email" id="correoDiligenciador" name="correo" placeholder="Ingrese el correo"
                            required>
                    </div>

                    <div class="input-box">
                        <label for="telefonoDiligenciador">Tel√©fono / Celular</label>
                        <input type="text" id="telefonoDiligenciador" name="telefonoDiligenciador"
                            placeholder="Ingrese el tel√©fono o celular" required>
                    </div>

                </div>



            </div> -->

      <!-- Informaci√≥n General del PPI -->
      <div class="form-section">
        <div class="input-box full-width">
          <h3 class="section-title">Entidad a la que postula</h3>
        </div>
        <label for="convocatorias">Seleccione la entidad donde deseea postular su idea (opcional)</label>

        <div id="convocatorias-list" style="display: flex; gap:20px">
          <!-- Checkboxes will be added here -->
        </div>

        <script src="/js/habilitarEvaluador.js"></script>

        <script>
          // Cargar convocatorias desde la API
          (async function cargarConvocatorias() {
            try {
              const res = await fetch('/api/aliados-proyectos');
              const convocatorias = await res.json();
              const container = document.getElementById('convocatorias-list');

              if (Array.isArray(convocatorias)) {
                convocatorias.forEach(conv => {
                  const div = document.createElement('div');
                  div.style.marginBottom = '8px';

                  const checkbox = document.createElement('input');
                  checkbox.type = 'checkbox';
                  checkbox.id = `conv_${conv.id}`;
                  checkbox.name = 'convocatorias';
                  checkbox.value = conv.id;

                  const label = document.createElement('label');
                  label.htmlFor = `conv_${conv.id}`;
                  label.textContent = conv.nombreAliado || `Convocatoria ${conv.id}`;
                  label.style.marginLeft = '5px';
                  label.style.cursor = 'pointer';

                  div.appendChild(checkbox);
                  div.appendChild(label);
                  container.appendChild(div);
                });
              }
            } catch (error) {
              console.error('Error cargando convocatorias:', error);
            }
          })();
        </script>
      </div>
      <div class="form-section">
        <h3 class="section-title">Informaci√≥n General del PPI</h3>

        <div class="input-box full-width">
          <label for="nombrePPI">Nombre del PPI (Programa/Proyecto/Iniciativa)</label>
          <input type="text" id="nombrePPI" name="nombrePPI" placeholder="Ingrese el nombre del PPI" required>
        </div>
        <div class="input-box full-width">
          <label for="determinanteProductividad">Determinante de productividad al que se encuentra asociado el
            PPI</label>
          <input type="text" id="determinanteProductividad" name="determinanteProductividad"
            placeholder="Ingrese el nombre del determinante de productividad al que se encuentra asociado el PPI"
            required>
        </div>
        <div class="input-box full-width">
          <label for="componenteProductividad">Componente de productividad al que se encuentra asociado el
            PPI</label>
          <input type="text" id="componenteProductividad" name="componenteProductividad"
            placeholder="Ingrese el nombre del componente de productividad al que se encuentra asociado el PPI"
            required>
        </div>
        <div class="input-box full-width">
          <label for="objetivo">Objetivo del PPI <br>
            (Sea claro para que el equipo de expertos pueda identificar si soluciona fallas de mercado,
            gobierno o articulaci√≥n)</label>
          <input type="text" id="objetivo" name="objetivo" placeholder="Ingrese el Objetivo del PPI" required>
        </div>
        <div class="input-box">
          <label for="objetivo">¬øQu√© necesidad o problema resuelve esta Iniciativa?</label>
          <input type="text" id="objetivo" name="objetivo" placeholder="Sea lo m√°s claro posible" required>
        </div>
        <div class="input-box full-width">
          <label for="impactos"> Liste los tres principales impactos a obtener con el PPI planteado</label>
          <input type="text" id="impactos" name="impactos" placeholder="Ingrese los impactos" required>
        </div>
        <div class="input-box full-width">
          <label for="objetivosEspecificos">Liste los objetivos espec√≠ficos del proyecto </label>
          <input type="text" id="objetivosEspecificos" name="objetivosEspecificos"
            placeholder="Ingrese los objetivos espec√≠ficos (M√°ximo 5)" required>

        </div>

        <div class="input-box full-width">
          <label for="duracionPPI">¬øCu√°l es la duraci√≥n estimada del PPI?</label>
          <select id="duracionPPI" name="duracionPPI" required>
            <option value="">Seleccione una opci√≥n</option>
            <option value="Menos de un a√±o">Menos de un a√±o</option>
            <option value="Entre un a√±o y tres a√±os">Entre un a√±o y tres a√±os</option>
            <option value="M√°s de tres a√±os">M√°s de tres a√±os</option>
          </select>
        </div>
        <div class="input-box full-width">
          <label for="presupuestoPPI">¬øCu√°l es el presupuesto estimado del PPI?</label>
          <select id="presupuestoPPI" name="duracionPPI" required>
            <option value="">Seleccione una opci√≥n</option>
            <option value="De 0 a 100 millones de pesos">De 0 a 100 millones de pesos</option>
            <option value="De 101 a 500 millones de pesos">De 101 a 500 millones de pesos</option>
            <option value="De 501 a 1000 millones de pesos">De 501 a 1000 millones de pesos</option>
            <option value="De 1001 a 5000 millones de pesos">De 1001 a 5000 millones de pesos</option>
            <option value="M√°s de 5000 millones de pesos">M√°s de 5000 millones de pesos</option>
          </select>
        </div>


        <div class="input-box full-width">
          <label for="fasePPI">¬øEn qu√© fase se encuentra actualmente el PPI?</label>
          <select id="fasePPI" name="fasePPI" required>
            <option value="">Seleccione una opci√≥n</option>
            <option value="Fase 1: Idea">Fase 1: Idea</option>
            <option value="Fase 2: Formulaci√≥n o Prefactibilidad">Fase 2: Formulaci√≥n o Prefactibilidad
            </option>
            <option value="Fase 3: Factibilidad">Fase 3: Factibilidad</option>
            <option value="Contrataci√≥n">Contrataci√≥n</option>
            <option value="Ejecuci√≥n">Ejecuci√≥n</option>
          </select>
        </div>

      </div>
      <div style="text-align:right; margin-top:20px;">
        <button class="modal-button" id="guardarFichaPPI">Guardar Ficha T√©cnica</button>
      </div>
      <!-- An√°lisis de Equidad de G√©nero y Superaci√≥n de la Pobreza -->
      <!-- <div class="form-section">
                <h3 class="section-title">An√°lisis de Equidad de G√©nero y Superaci√≥n de la Pobreza </h3>

                <div class="input-box full-width">
                    <label for="Potencial">Potencial de generaci√≥n de empleo por estratos cuando el proyecto est√© en
                        desarrollo:</label>
                    <table class="PPI">
                        <thead>
                            <tr>
                                <th>Rango De Empleos</th>
                                <th>Estratos 1 y 2</th>
                                <th>Estratos 3 y 4</th>
                                <th>Estratos 5 y 6</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="text-align:center;">1 a 10 </td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="1-10-1y2"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="1-10-3y4"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="1-10-5y6"></td>
                            </tr>
                            <tr>
                                <td style="text-align:center;">11 a 20 </td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="11-20-1y2"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="11-20-3y4"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="11-20-5y6"></td>
                            </tr>
                            <tr>
                                <td style="text-align:center;">21 a 30 </td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="21-30-1y2"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="21-30-3y4"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="21-30-5y6"></td>
                            </tr>
                            <tr>
                                <td style="text-align:center;">31 a o m√°s </td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="31+-1y2"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="31+-3y4"></td>
                                <td style="text-align:center;"><input type="radio" name="potencialEmpleo"
                                        value="31+-5y6"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <br>
                <hr>
                <br>
                <div class="input-box full-width">
                    <label for="impactoEmpleo">Impactos esperados en generaci√≥n de empleo con la ejecuci√≥n del programa,
                        proyecto o iniciativa </label>
                    <input type="text" id="impactoEmpleo" name="impactoEmpleo"
                        placeholder="Ingrese los impactos esperados en la generaci√≥n de empleo con la ejecuci√≥n del PPI"
                        required>
                </div>
                <div class="input-box full-width">
                    <label for="impactoEquidad">Impactos esperados en reducci√≥n de brechas de equidad de g√©nero con la
                        ejecuci√≥n del programa, proyecto o iniciativa
                    </label>
                    <input type="text" id="impactoEquidad" name="impactoEquidad"
                        placeholder="Ingrese los Impactos esperados en reducci√≥n de brechas de equidad de g√©nero con la ejecuci√≥n del PPI"
                        required>
                </div>
                <div class="input-box full-width">
                    <label for="politicasPPI">Indique si el proyecto contempla pol√≠ticas de equidad de g√©nero para la
                        contrataci√≥n de sus empleados. Cu√°les?

                    </label>
                    <input type="text" id="politicasPPI" name="politicasPPI"
                        placeholder="Ingrese las politicas de equidad de g√©nero para la contrataci√≥n" required>
                </div>
            </div> -->
    </div>
  </div>

  <!-- Mis Proyectos -->
  <div class="main-content">
    <div style="display: flex;   justify-content: space-between;">
      <h2 class="title" id="misProyectos">Proyectos de </h2>
      </h2>

    </div>


    <!-- Filtros -->
    <div class="proyecto-controls">
      <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        <div class="control-group">
          <label class="control-label">Buscar proyecto</label>
          <input type="text" id="buscarMisProyectos" placeholder="Buscar tus proyectos..." class="control-input">
        </div>
        <div class="control-group">
          <label class="control-label">Lider del PPI</label>
          <select class="control-select" id="filter-responsable">
            <option value="">Todos los responsables</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">Fase del PPI</label>
          <select class="control-select" id="filter-estado">
            <option value="">Selecciona la fase</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">Postulado a</label>
          <select class="control-select" id="filter-postulado">
            <option value="">Selecciona la entidad</option>
          </select>
        </div>
        <div class="control-group">
          <button class="filter-btn" id="filter-misIdeas"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
      </div>
      <button class="action-button" id="postulaciones" style="display: block; ">
        <span class="button-icon"><i class="bi bi-lightbulb-fill "></i></span>
        Nueva idea PPI
      </button>
    </div>

    <!-- Tabla de Mis Proyectos -->
    <table class="data-table" id="tablaPostulaciones">
      <thead>
        <tr>
          <th>Codigo</th>
          <th>Nombre del proyecto</th>
          <th>Objetivo</th>
          <th>Entidad Responsable</th>
          <th>Postulado a</th>
          <th>L√≠der PPI</th>
          <th>Duraci√≥n</th>
          <th>Estado</th>
          <th>Ver</th>
        </tr>
      </thead>
      <tbody id="cuerpoTablaPostulaciones">
        <!-- Filas de datos se generar√°n din√°micamente aqu√≠ -->

      </tbody>
    </table>

    <div id="paginador" style="margin-top:15px; text-align:center;"></div>



  </div>


  <footer class="footer">

    <div class="footer-content">

      <!-- Izquierda -->
      <div class="footer-left">
        <img src="/img/logo1.png" alt="SINAPTICO" class="footer-logo">
        <p class="footer-desc">Conectando conocimiento, innovaci√≥n y tecnolog√≠a.</p>


      </div>

      <!-- Enlaces en dos columnas -->
      <div class="footer-links">
        <h4>Explorar</h4>
        <div class="links-grid">
          <a href="/helice">Inicio</a>
          <a></a>
          <a href="/directorio">Directorio Empresas</a>
          <a href="/directorioPersonas">Directorio Personas</a>
          <a href="/proyectos">Proyectos</a>
          <a href="/ofertaRegional">Oferta Regional</a>
          <a href="/retosEmpresariales">Retos Empresariales</a>
          <a href="/retosAula">Retos de Aula</a>
          <a href="/conocimientoCursosVirtuales">Cursos</a>
          <a href="/conocimientoBiblioteca">Biblioteca</a>
          <a href="/convocatorias">Convocatorias</a>
          <a href="/eventos">Eventos</a>
        </div>
      </div>

      <!-- Redes sociales -->
      <div class="footer-social">
        <h4>S√≠guenos</h4>
        <div class="social-icons">
          <a href="#"><i class="bi bi-facebook"></i></a>
          <a href="#"><i class="bi bi-twitter"></i></a>
          <a href="#"><i class="bi bi-linkedin"></i></a>
          <a href="#"><i class="bi bi-instagram"></i></a>
        </div>
      </div>

      <!-- Contacto -->
      <div class="footer-contact">
        <h4>Cont√°ctanos</h4>

        <p>Cra.19 #35-02 - UIS Bucarica</p>
        <p>Bucaramanga, Colombia</p>

        <div class="contact-item">
          <i class="bi bi-envelope"></i>
          <span>info@cpcoriente.org</span>
        </div>

        <div class="contact-item">
          <i class="bi bi-telephone"></i>
          <span>+57 315 494 0296</span>
        </div>
      </div>

    </div>

    <div class="footer-bottom">
      <img src="/logos/logoCPCblanco.png" alt="SINAPTICO" class="footer-logoCPC">
      <p>¬© 2025 CPC Oriente. Todos los derechos reservados.</p>

    </div>

  </footer>


  <!--Crear idea PPI-->
  <script>
    document.getElementById('guardarFichaPPI').onclick = async function () {
      // Recoge los datos del formulario
      const data = {
        entidadId: document.getElementById('nombreEntidad').value === 'null' ? null : document.getElementById('nombreEntidad').value,
        userId: obtenerCookie("userId"),
        userLiderId: document.getElementById('nombreLider').value,
        nombrePPI: document.getElementById('nombrePPI').value,
        determinanteProductividad: document.getElementById('determinanteProductividad').value,
        componenteProductividad: document.getElementById('componenteProductividad').value,
        objetivo: document.getElementById('objetivo').value,
        necesidadProblema: document.querySelectorAll('#objetivo')[1]?.value || '',
        impactos: document.getElementById('impactos').value,
        objetivosEspecificos: document.getElementById('objetivosEspecificos').value,
        duracionPPI: document.getElementById('duracionPPI').value,
        presupuestoPPI: document.getElementById('presupuestoPPI').value,
        fasePPI: document.getElementById('fasePPI').value,
        correoLider: document.getElementById('correoLider').value,
        telefonoLider: document.getElementById('telefonoLider').value,
        rangoDeEmpleos: 'sin usar',
        estratosBeneficiarios: 'sin usar',
        potencialEmpleo: 'sin usar',
        impactoEmpleo: 'sin usar',
        impactoEquidad: 'sin usar',
        politicasPPI: 'sin usar',
        postulacion: Array.from(document.querySelectorAll('input[name="convocatorias"]:checked')).map(cb => cb.value)
      };
      console.log(data);
      // Validaci√≥n r√°pida
      // Si entidadId es null, no lo validamos como error
      for (const key in data) {
        if (key !== 'entidadId' && !data[key]) {
          Swal.fire('Faltan datos', `Por favor completa el campo: ${key}.`, 'warning');
          return;
        }
      }

      try {
        const res = await fetch('/api/proyectos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (res.ok) {
          Swal.fire('Guardado', 'Ficha t√©cnica enviada correctamente.', 'success').then(() => {
            document.getElementById('modalPostulaciones').style.display = 'none';
            location.reload();
          });
        } else {
          Swal.fire('Error', result.message || 'No se pudo guardar.', 'error');
        }
      } catch (err) {
        Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error');
      }
    };
  </script>

  <!--Detalles de mis proyectos-->
  <script>
    function verMasProyecto(proyectoId) {
      fetch(`/api/proyectos/${proyectoId}`)
        .then(res => res.json())
        .then(proyecto => {
          // Crea el modal si no existe
          console.log('Proyecto cargado para ver m√°s:', proyecto);
          let modal = document.getElementById('modalVerProyecto');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'modalVerProyecto';
            modal.className = 'modal';
            modal.innerHTML = `
           
                    <div class="modal-content" style="max-width:900px;">
                        <span class="close" id="cerrarModalVerProyecto">&times;</span>

                        <div id="contenidoVerProyecto" ></div>
                    </div>
                `;
            document.body.appendChild(modal);
            document.getElementById('cerrarModalVerProyecto').onclick = function () {
              modal.style.display = 'none';
            };
          }
          // Llena el contenido con tarjetas y estilos
          console.log('Proyecto cargado para ver m√°s:', proyecto);

          const contenido = document.getElementById('contenidoVerProyecto');
          contenido.innerHTML = `
                                           
                        <div style="margin-bottom:20px; display: flex; justify-content: space-between; align-items: center;">
                         
                            <h2>P-2025-${proyecto.id || ''} ${proyecto.nombrePPI || ''}</h2>
                             
                        </div>
                     
                        <div class="form-section">
                            <h4 class="section-title">Informaci√≥n General</h4>
                            <!-- nombres cient√≠ficos -->

                            <p><b>Objetivo </b> ${proyecto.objetivo || ''}</p>
                            <p><b>Problema:</b> ${proyecto.necesidadProblema || ''}</p>
                            <p><b>Impactos:</b> ${proyecto.impactos || ''}</p>
                            <p><b>Objetivos espec√≠ficos:</b> ${proyecto.objetivosEspecificos || ''}</p>
                        </div>
             
                        <div class="form-section">
                            <h4 class="section-title">Detalles T√©cnicos</h4>
                            <p><b>Entidad:</b> ${proyecto.entidad?.razonSocial || 'Independiente'}</p>
                            <p><b>Duraci√≥n:</b> ${proyecto.duracionPPI || ''}</p>
                            <p><b>Presupuesto:</b> ${proyecto.presupuestoPPI || ''}</p>
                            <p><b>Fase:</b> ${proyecto.fasePPI || ''}</p>
                            <p><b>Determinante productividad:</b> ${proyecto.determinanteProductividad || ''}</p>
                            <p><b>Componente productividad:</b> ${proyecto.componenteProductividad || ''}</p>
                        </div>
                    </div>
                
                        <div class="form-section">
                            <h4 class="section-title" >Contacto Responsable</h4>
                            <p><b>Nombre:</b> ${proyecto.usuarioLider?.name || ''}</p>
                            <p><b>Correo:</b> <a href="mailto:${proyecto.usuarioLider?.email || ''}" style="color:#007bff;">${proyecto.usuarioLider?.email || ''}</a></p>
                            <p><b>Tel√©fono:</b> <a href="tel:${proyecto.usuarioLider?.telefono || ''}" style="color:#007bff;">${proyecto.usuarioLider?.telefono || ''}</a></p>
                        </div>
                    </div>
                </div>
            `;

          modal.style.display = 'block';
        })
        .catch(() => {
          Swal.fire('Error', 'No se pudo cargar el proyecto.', 'error');
        });
    }
  </script>

  <!--Mis proyectos-->
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);

      // üëâ Cache del usuario actual para usarlo en "Independiente"
      let userSelf = { id: null, name: '', email: '', telefono: '' };

      function setContacto(email = '', telefono = '') {

        $('correoLider').value = email || '';
        $('telefonoLider').value = telefono || '';
      }

      function renderSelectLider(options = [], preselectValue = null) {
        const old = $('nombreLider');
        const select = document.createElement('select');
        select.id = 'nombreLider';
        select.name = 'nombreLider';
        select.required = true;

        options.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.value;
          opt.text = o.label;
          opt.dataset.email = o.email || '';
          opt.dataset.telefono = o.telefono || '';
          if (preselectValue && preselectValue == o.value) opt.selected = true;
          select.appendChild(opt);
        });

        select.addEventListener('change', () => {
          const sel = select.options[select.selectedIndex];
          setContacto(sel?.dataset.email, sel?.dataset.telefono);
        });

        old?.parentNode.replaceChild(select, old);

        if (select.options.length > 0) {
          const sel = select.options[select.selectedIndex];
          setContacto(sel?.dataset.email, sel?.dataset.telefono);
        } else {
          setContacto('', '');
        }
      }

      function renderSelectEntidad({ empresa } = {}) {
        const old = $('nombreEntidad');
        const select = document.createElement('select');
        select.id = 'nombreEntidad';
        select.name = 'nombreEntidad';
        select.required = true;

        const optInd = document.createElement('option');
        optInd.value = 'null';
        optInd.text = 'Independiente';
        select.appendChild(optInd);

        let preselect = 'null';
        if (empresa && empresa.id) {
          const optEmp = document.createElement('option');
          optEmp.value = String(empresa.id);
          optEmp.text = empresa.razonSocial || `Empresa ${empresa.id}`;
          select.appendChild(optEmp);
          preselect = String(empresa.id);
        }

        select.value = preselect;

        // üí° Al cambiar entidad: si es Independiente, seteamos contacto del usuario
        select.addEventListener('change', async () => {
          await onEntidadChange(select.value);
        });

        old?.parentNode.replaceChild(select, old);
        return preselect;
      }

      async function loadLideresPorEmpresa(empresaId) {
        const res = await fetch(`/api/usuarioempresa/empresa/${empresaId}`);
        const data = await res.json();
        const opciones = (Array.isArray(data) ? data : []).map(item => ({
          value: String(item.User.id),
          label: `${item.User.name} (${item.Cargo?.nombre || '‚Äî'})`,
          email: item.User.email || '',
          telefono: item.User.telefono || ''
        }));
        renderSelectLider(opciones);
      }

      // ‚úÖ Ahora recibe userSelf y actualiza contacto
      function setIndependienteAsLider() {
        renderSelectLider([{
          value: String(userSelf.id || obtenerCookie("userId")),
          label: userSelf.name || 'Usuario Actual',
          email: userSelf.email || '',
          telefono: userSelf.telefono || ''
        }], String(userSelf.id || obtenerCookie("userId")));
        console
        // Fuerza contacto del usuario (por si ven√≠amos con datos de empresa)
        // Trae email y tel√©fono del usuario actual por fetch
        fetch(`/api/user/${userSelf.id}`)
          .then(res => res.json())
          .then(user => {
            setContacto(user.email || '', user.telefono || '', user.name || '');
          })
          .catch(() => {
            setContacto(userSelf.email || '', userSelf.telefono || '', userSelf.name || '');
          });
      }

      async function onEntidadChange(empresaValue) {
        if (empresaValue && empresaValue !== 'null') {
          await loadLideresPorEmpresa(empresaValue);
        } else {
          setIndependienteAsLider();
        }
      }

      // üß† Abrir modal: cargamos user+empresa, llenamos entidad, y luego l√≠deres/independiente
      $('postulaciones').addEventListener('click', async () => {
        $('modalPostulaciones').style.display = 'block';
        try {
          const res = await fetch(`/api/usuarioempresa/user/${userId}`);
          const data = await res.json();

          // Intenta sacar el usuario del payload recibido (aj√∫stalo si tu API difiere)
          const userFromApi = Array.isArray(data) ? (data[0]?.User || data[0]?.user) : null;

          userSelf = {
            id: userFromApi?.id || obtenerCookie("userId"),
            name: $('bienvenido')?.innerText?.replace('Hola ', '') || userFromApi?.name || '',
            email: userFromApi?.email || ($('correoUsuario')?.value || ''),     // opcional: hidden input #correoUsuario
            telefono: userFromApi?.telefono || ($('telefonoUsuario')?.value || '') // opcional: hidden input #telefonoUsuario
          };

          const empresa = (Array.isArray(data) && data[0]?.empresa) ? data[0].empresa : null;

          const seleccionado = renderSelectEntidad({ empresa });
          await onEntidadChange(seleccionado);
        } catch (err) {
          console.error('Error cargando usuario/empresa:', err);
          // Fallback: usuario independiente
          const nombre = $('bienvenido')?.innerText?.replace('Hola ', '') || 'Yo';
          userSelf = {
            id: obtenerCookie("userId"),
            name: nombre,
            email: $('correoUsuario')?.value || '',     // si agregas estos inputs hidden
            telefono: $('telefonoUsuario')?.value || ''
          };
          renderSelectEntidad({ empresa: null });
          setIndependienteAsLider();
        }
      });

      $('cerrarModalPostulaciones').addEventListener('click', () => {
        $('modalPostulaciones').style.display = 'none';
      });
    })();
  </script>
  <!-- Paginaci√≥n de mis proyectos -->
  <script>

    // =========================
    // Paginaci√≥n
    // =========================
    let paginaActual = 1;
    const itemsPorPagina = 5;
    let listaFiltrada = []; // para mantener los resultados actuales

    function mostrarPaginador(lista) {
      const paginadorDiv = document.getElementById('paginador');
      if (!paginadorDiv) return;

      const totalPaginas = Math.ceil(lista.length / itemsPorPagina);
      if (totalPaginas <= 1) {
        paginadorDiv.innerHTML = '';
        return;
      }

      let botones = '';
      for (let i = 1; i <= totalPaginas; i++) {
        botones += `
      <button 
        class="btn-pagina ${i === paginaActual ? 'activo' : ''}" 
        onclick="cambiarPagina(${i})">
        ${i}
      </button>
    `;
      }

      paginadorDiv.innerHTML = `
    <button class="btn-pagina" onclick="cambiarPagina(${paginaActual - 1})" ${paginaActual === 1 ? 'disabled' : ''}>¬´ Anterior</button>
    ${botones}
    <button class="btn-pagina" onclick="cambiarPagina(${paginaActual + 1})" ${paginaActual === totalPaginas ? 'disabled' : ''}>Siguiente ¬ª</button>
  `;
    }

    function cambiarPagina(nuevaPagina) {
      const totalPaginas = Math.ceil(listaFiltrada.length / itemsPorPagina);
      if (nuevaPagina < 1 || nuevaPagina > totalPaginas) return;
      paginaActual = nuevaPagina;
      renderizarPagina();
    }

    function renderizarPagina() {
      const inicio = (paginaActual - 1) * itemsPorPagina;
      const fin = inicio + itemsPorPagina;
      const pagina = listaFiltrada.slice(inicio, fin);
      mostrarProyectos(pagina);
      mostrarPaginador(listaFiltrada);
    }

    // Variables globales
    // =========================
    let proyectosCargados = [];
    let entidadId = null;


    document.addEventListener("DOMContentLoaded", async () => {


      const resUE = await fetch(`/api/usuarioempresa/user/${userId}`);
      const dataUE = await resUE.json();

      if (Array.isArray(dataUE) && dataUE.length > 0 && dataUE[0].empresa) {
        entidadId = dataUE[0].empresa.id;
      } else {
        entidadId = 'null';
      }


      console.log('Entidad ID seleccionada:', entidadId);

      await cargarProyectos(); //cargamos los proyectos
    });

    // =========================
    // Cargar proyectos
    // =========================
    async function cargarProyectos() {
      try {
        const resProy = await fetch(`/api/proyectos/entidadomis/${userId}/${entidadId}`);
        const dataProy = await resProy.json();
        proyectosCargados = Array.isArray(dataProy) ? dataProy : [];
        console.log("‚úÖ Proyectos cargados:", proyectosCargados);
        listaFiltrada = proyectosCargados;
        paginaActual = 1;
        renderizarPagina();
        llenarFiltros(proyectosCargados);
      } catch (err) {
        console.error("‚ùå Error cargando proyectos:", err);
      }
    }

    // =========================
    // Renderizar tabla
    // =========================
    function mostrarProyectos(lista) {
      const tbody = document.getElementById('cuerpoTablaPostulaciones');
      if (!tbody) return;

      if (!lista.length) {
        tbody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align:center; color:#777;">No hay proyectos encontrados</td>
        </tr>`;
        return;
      }

      tbody.innerHTML = '';
      lista.forEach(proyecto => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td>${proyecto.id || ''}</td>
        <td>${proyecto.nombrePPI || ''}</td>
        <td>${proyecto.objetivo || ''}</td>
        <td>${proyecto.entidad?.razonSocial || 'Independiente'}</td>
        <td>
            <div style="display:flex; flex-direction:column; gap:4px;">
            ${proyecto.aliadosAplicados?.length
            ? proyecto.aliadosAplicados.map(a =>
              `<span style="display:inline-block; background:#e8f4f8; border:1px solid #b3d9e6; border-radius:4px; padding:4px 8px; font-size:0.9em;">
                  ID: ${a?.id || 'N/A'} - ${a.aliadoProyecto?.nombreAliado || 'N/A'}
                </span>`
            ).join('')
            : (proyecto.convocatoriasAplicadas?.length
              ? proyecto.convocatoriasAplicadas.map(c =>
                `<span style="display:inline-block; background:#e8f4f8; border:1px solid #b3d9e6; border-radius:4px; padding:4px 8px; font-size:0.9em;">
                CRCI  ${c.convocatoria?.numero || 'N/A'}
                  </span>`
              ).join('')
              : '<span style="color:#999;">Sin postulaciones</span>')
          }
          </div>
        </td>
        <td>${proyecto.usuarioLider?.name || ''}</td>
        <td>${proyecto.duracionPPI || ''}</td>
        <td>${proyecto.fasePPI || ''}</td>
        <td>
          <button class="action-button" onclick="verMasProyecto(${proyecto.id})" style="justify-content:center;">
            <i class="bi bi-clipboard-fill"></i>
          </button>
        </td>
      `;
        tbody.appendChild(tr);
      });
    }

    // =========================
    // Llenar selects de filtros
    // =========================
    function llenarFiltros(data) {
      console.log("llenar filtro", data)

      const responsableSelect = document.getElementById('filter-responsable');
      const estadoSelect = document.getElementById('filter-estado');
      const postuladoSelect = document.getElementById('filter-postulado');

      responsableSelect.innerHTML = '<option value="">Responsables</option>';
      estadoSelect.innerHTML = '<option value="">Selecciona el estado</option>';
      postuladoSelect.innerHTML = '<option value="">Selecciona la entidad</option>';

      const responsables = [...new Set(
        data.map(p => p.usuarioLider?.name || "Sin responsable")
      )];

      const estados = [...new Set(data.map(p => p.fasePPI).filter(Boolean))];
      const postulados = [...new Set(
        data.flatMap(p => (p.aliadosAplicados || []).map(a => a.aliadoProyecto?.nombreAliado)).filter(Boolean)
      )];

      responsables.forEach(r => responsableSelect.insertAdjacentHTML('beforeend', `<option value="${r}">${r}</option>`));
      estados.forEach(e => estadoSelect.insertAdjacentHTML('beforeend', `<option value="${e}">${e}</option>`));
      postulados.forEach(p => postuladoSelect.insertAdjacentHTML('beforeend', `<option value="${p}">${p}</option>`));
    }

    // =========================
    // Aplicar filtros
    // =========================
    function aplicarFiltros() {
      const texto = document.getElementById('buscarMisProyectos').value.toLowerCase();
      const responsable = document.getElementById('filter-responsable').value;
      const estado = document.getElementById('filter-estado').value;
      const postulado = document.getElementById('filter-postulado').value;

      const filtrados = proyectosCargados.filter(p => {
        const coincideTexto =
          !texto ||
          p.nombrePPI?.toLowerCase().includes(texto) ||
          p.objetivo?.toLowerCase().includes(texto) ||
          p.usuarioLider?.name?.toLowerCase().includes(texto) ||
          p.entidad?.razonSocial?.toLowerCase().includes(texto);

        const coincideResponsable = !responsable || p.usuarioLider?.name === responsable;
        const coincideEstado = !estado || p.fasePPI === estado;
        const coincidePostulado = !postulado || (p.aliadosAplicados || []).some(a => a.aliadoProyecto?.nombreAliado === postulado);

        return coincideTexto && coincideResponsable && coincideEstado && coincidePostulado;
      });

      console.log("üìä Proyectos filtrados:", filtrados);
      listaFiltrada = filtrados;
      paginaActual = 1;
      renderizarPagina();

    }

    // =========================
    // Eventos de filtros
    // =========================
    document.getElementById('buscarMisProyectos').addEventListener('input', aplicarFiltros);
    document.getElementById('filter-responsable').addEventListener('change', aplicarFiltros);
    document.getElementById('filter-estado').addEventListener('change', aplicarFiltros);
    document.getElementById('filter-postulado').addEventListener('change', aplicarFiltros);

    // Bot√≥n limpiar
    document.getElementById('filter-misIdeas').addEventListener('click', () => {
      document.getElementById('buscarMisProyectos').value = '';
      document.getElementById('filter-responsable').value = '';
      document.getElementById('filter-estado').value = '';
      document.getElementById('filter-postulado').value = '';
      listaFiltrada = proyectosCargados;
      paginaActual = 1;
      renderizarPagina();

    });
  </script>

  <script src="/js/config.js"></script>
  <script src="/js/nav.js"></script>
  <script src="js/notificaciones.js"></script>
  <script src="/js/websocket.js"></script>
  <script src="/js/menuGeneral.js"></script>
  <script src="/js/habilitarEvaluador.js"></script>

</body>

</html>